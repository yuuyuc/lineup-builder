<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LINEUP BUILDER</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+JP:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --pitch: #2a5c14;
  --panel: #0c0c0c;
  --panel-mid: #161616;
  --panel-border: #262626;
  --accent: #c8f560;
  --accent2: #60d5f5;
  --text: #f0f0e8;
  --text-dim: #666;
  --danger: #f56060;
  --warn: #f5a623;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--panel);color:var(--text);font-family:'Noto Sans JP',sans-serif;height:100vh;max-height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* HEADER */
header{background:#080808;border-bottom:1px solid var(--panel-border);padding:10px 20px;display:flex;align-items:center;gap:16px;flex-shrink:0;z-index:10;}
header h1{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:4px;color:var(--accent);}
header .subtitle{font-size:0.68rem;color:var(--text-dim);letter-spacing:2px;}
header .spacer{flex:1;}
.header-btn{background:#1a1a1a;border:1px solid var(--panel-border);color:var(--text-dim);padding:6px 14px;font-size:0.75rem;font-family:'Noto Sans JP',sans-serif;cursor:pointer;border-radius:4px;transition:all .15s;}
.header-btn:hover{border-color:var(--accent);color:var(--accent);}

/* LAYOUT */
.app{display:grid;grid-template-columns:290px 1fr 260px;flex:1;min-height:0;max-height:calc(100vh - 53px);overflow:hidden;}

/* â”€â”€ RESPONSIVE: MOBILE â”€â”€ */
@media (max-width: 768px) {
  body{height:auto;max-height:none;overflow:auto;}
  header{padding:8px 12px;}
  header h1{font-size:1.3rem;letter-spacing:2px;}
  .header-btn{padding:5px 9px;font-size:0.65rem;}

  /* Mobile: ç¸¦ç©ã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .app{display:flex;flex-direction:column;max-height:none;height:auto;overflow:visible;}

  /* Left panel: collapsible sections */
  .left-panel{height:auto;overflow:visible;border-right:none;border-bottom:1px solid var(--panel-border);order:1;}
  .panel-section{padding:7px 10px;}
  .formation-grid{grid-template-columns:repeat(4,1fr);max-height:none;gap:3px;}
  .formation-btn{font-size:0.72rem;padding:4px 1px;}
  .player-list-wrap{max-height:160px;overflow-y:auto;}
  .custom-panel{max-height:200px;}
  .custom-tab-content.active{max-height:110px;}

  /* Pitch: ã»ã¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
  .pitch-area{order:2;height:calc(100vw * 11/7);max-height:94vw;min-height:0;}
  .pitch-wrap{width:min(100%, calc(100vw * 7/11));height:min(100%, 94vw);margin:auto;}
  .pp-icon{width:46px;height:46px;}
  .pp-label{font-size:0.60rem;max-width:66px;padding:2px 5px;}
  .pp-badge{width:15px;height:15px;font-size:0.60rem;}
  .pp-remove{display:flex;width:16px;height:16px;font-size:0.6rem;}

  /* Right panel */
  .right-panel{height:auto;overflow:visible;border-left:none;border-top:1px solid var(--panel-border);order:3;}
  .lineup-scroll{max-height:300px;overflow-y:auto;}
  .ls-icon{width:38px;height:38px;}
  .ls-name{font-size:0.76rem;}
  .lineup-actions{flex-direction:row;flex-wrap:wrap;gap:4px;padding:8px;}
  .btn-full{font-size:.78rem;padding:8px 4px;flex:1;min-width:0;letter-spacing:.5px;}
  .modal{width:96vw;max-height:82vh;}
}
@media (max-width: 480px) {
  header h1{font-size:1.1rem;}
  .formation-grid{grid-template-columns:repeat(3,1fr);}
  .pitch-area{height:calc(100vw * 11/7);max-height:98vw;}
  .pp-icon{width:40px;height:40px;}
  .pp-label{font-size:0.55rem;max-width:56px;}
}

/* PANELS */
.left-panel{background:var(--panel-mid);border-right:1px solid var(--panel-border);display:flex;flex-direction:column;overflow:hidden;height:100%;}
.right-panel{background:var(--panel-mid);border-left:1px solid var(--panel-border);display:flex;flex-direction:column;overflow:hidden;height:100%;}
.panel-section{padding:12px 14px;border-bottom:1px solid var(--panel-border);flex-shrink:0;}
.panel-label{font-size:0.6rem;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:8px;font-weight:700;}
.panel-label-sm{font-size:0.6rem;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:6px;}

select,input[type=text]{width:100%;background:#0e0e0e;border:1px solid var(--panel-border);color:var(--text);padding:7px 10px;font-family:'Noto Sans JP',sans-serif;font-size:0.82rem;border-radius:4px;outline:none;transition:border-color .2s;}
select:focus,input:focus{border-color:var(--accent);}
select option{background:#111;}

/* FORMATION GRID */
.formation-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;margin-top:6px;max-height:180px;overflow-y:auto;}
.formation-btn{background:#0e0e0e;border:1px solid var(--panel-border);color:var(--text-dim);padding:5px 2px;font-family:'Bebas Neue',sans-serif;font-size:0.82rem;letter-spacing:0.5px;cursor:pointer;border-radius:4px;transition:all .15s;text-align:center;}
.formation-btn:hover{border-color:var(--accent);color:var(--accent);}
.formation-btn.active{background:var(--accent);color:#000;border-color:var(--accent);}

/* TEAM SELECT ROW */
.team-select-row{display:flex;gap:6px;}
.team-select-row select{flex:1;}

/* PLAYER LIST */
.player-list-wrap{flex:1;overflow-y:auto;padding:6px;min-height:0;}
.player-list-wrap::-webkit-scrollbar{width:3px;}
.player-list-wrap::-webkit-scrollbar-thumb{background:#2a2a2a;border-radius:2px;}
.player-search-input{margin-bottom:6px;}

.player-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:6px;cursor:pointer;transition:background .12s;margin-bottom:2px;position:relative;}
.player-item:hover{background:#202020;}
.player-item.in-lineup{opacity:.4;cursor:default;}
.player-item.in-lineup:hover{background:transparent;}
.p-avatar{width:34px;height:34px;border-radius:50%;background:#1e1e1e;border:2px solid #2a2a2a;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:0.9rem;}
.p-avatar img{width:100%;height:100%;object-fit:cover;}
.p-info{flex:1;min-width:0;}
.p-name{font-size:0.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.p-meta{font-size:0.68rem;color:var(--text-dim);}
.p-num{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--text-dim);width:20px;text-align:center;flex-shrink:0;}
.p-del{background:none;border:none;color:var(--danger);cursor:pointer;font-size:0.8rem;padding:2px 4px;opacity:0;transition:opacity .15s;}
.player-item:hover .p-del{opacity:1;}

/* CUSTOM PLAYER PANEL */
.custom-panel{padding:12px 14px;border-bottom:1px solid var(--panel-border);flex-shrink:0;overflow:hidden;max-height:260px;}
.custom-tabs{display:flex;gap:4px;margin-bottom:10px;}
.custom-tab{flex:1;background:#0e0e0e;border:1px solid var(--panel-border);color:var(--text-dim);padding:5px;font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;cursor:pointer;border-radius:3px;text-align:center;transition:all .15s;}
.custom-tab.active{background:var(--accent);color:#000;border-color:var(--accent);}
.custom-tab-content{display:none;}
.custom-tab-content.active{display:block;max-height:160px;overflow-y:auto;}
.search-row{display:flex;gap:5px;margin-bottom:6px;}
.search-row input{flex:1;}
.btn-xs{background:var(--accent);color:#000;border:none;padding:6px 10px;font-family:'Noto Sans JP',sans-serif;font-size:0.72rem;font-weight:700;cursor:pointer;border-radius:3px;white-space:nowrap;transition:opacity .2s;flex-shrink:0;}
.btn-xs:hover{opacity:.85;}
.btn-xs.sec{background:#2a2a2a;color:var(--text);}
.btn-xs.danger{background:var(--danger);color:#fff;}
.img-results{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;max-height:120px;overflow-y:auto;}
.img-cand{width:44px;height:44px;border-radius:4px;object-fit:cover;cursor:pointer;border:2px solid transparent;transition:border-color .15s;background:#1a1a1a;display:block;}
.img-cand:hover,.img-cand.picked{border-color:var(--accent);}
.custom-note{font-size:0.68rem;color:var(--text-dim);margin-top:4px;line-height:1.4;}
.custom-preview-row{display:flex;align-items:center;gap:8px;margin-top:8px;}
.custom-preview-row .p-avatar{width:40px;height:40px;}
.custom-form-row{display:grid;grid-template-columns:1fr auto auto;gap:5px;margin-top:6px;}
.upload-label{display:inline-flex;align-items:center;gap:4px;background:#2a2a2a;color:var(--text-dim);padding:6px 10px;border-radius:3px;cursor:pointer;font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;border:1px solid var(--panel-border);transition:all .15s;}
.upload-label:hover{border-color:var(--accent);color:var(--accent);}
input[type=file]{display:none;}

/* PITCH */
.pitch-area{position:relative;display:flex;align-items:stretch;justify-content:center;background:#101410;overflow:hidden;}
/* 2ãƒãƒ¼ãƒ æ™‚: GKãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«pitch-containerãŒè‡ªèº«ã®pitch-wrapã‚’clipã™ã‚‹ */
.pitch-wrap{position:relative;height:100%;aspect-ratio:7/11;max-width:100%;flex-shrink:0;}
.pitch-svg{position:absolute;inset:0;width:100%;height:100%;}
.pitch-players{position:absolute;inset:0;}
.pitch-player{position:absolute;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform .2s;user-select:none;z-index:2;}
.pitch-player:hover{transform:translate(-50%,-50%) scale(1.08);}
.pp-icon{width:54px;height:54px;border-radius:50%;background:#1a3010;border:3px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;color:var(--text-dim);overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,.6);position:relative;flex-shrink:0;}
.pp-icon img{width:100%;height:100%;object-fit:cover;}
.pp-icon.empty{border-color:#333;background:rgba(0,0,0,.4);}
.pp-badge{position:absolute;bottom:-2px;right:-2px;background:var(--accent);color:#000;font-family:'Bebas Neue',sans-serif;font-size:0.65rem;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:3;}
.pp-label{margin-top:4px;font-size:0.65rem;font-weight:700;background:rgba(0,0,0,.75);padding:2px 6px;border-radius:10px;max-width:72px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;backdrop-filter:blur(4px);}
.pp-label.empty{color:var(--text-dim);}
.pp-remove{position:absolute;top:-5px;right:-5px;width:17px;height:17px;background:var(--danger);border:none;border-radius:50%;color:#fff;font-size:0.65rem;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:4;}
.pitch-player:hover .pp-remove{display:flex;}

/* RIGHT PANEL - LINEUP */
.lineup-scroll{flex:1;overflow-y:auto;padding:8px;}
.lineup-scroll::-webkit-scrollbar{width:3px;}
.lineup-scroll::-webkit-scrollbar-thumb{background:#2a2a2a;border-radius:2px;}
.lineup-slot{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:5px;border:1px solid var(--panel-border);margin-bottom:4px;background:#0e0e0e;transition:border-color .15s;cursor:pointer;}
.lineup-slot.filled{border-color:rgba(200,245,96,.2);}
.ls-num{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--text-dim);width:18px;text-align:center;flex-shrink:0;}
.ls-icon{width:42px;height:42px;border-radius:50%;background:#1a1a1a;border:2px solid #2a2a2a;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:0.85rem;font-weight:700;flex-shrink:0;}
.ls-icon img{width:100%;height:100%;object-fit:cover;}
.ls-info{flex:1;min-width:0;}
.ls-name{font-size:0.80rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ls-pos{font-size:0.65rem;color:var(--text-dim);}
.ls-clear{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:0.75rem;padding:4px 6px;border-radius:3px;transition:color .15s;flex-shrink:0;}
.ls-clear:hover{color:var(--danger);}
.lineup-slot:hover{border-color:rgba(200,245,96,.3);background:#111;}
.lineup-actions{padding:12px 14px;border-top:1px solid var(--panel-border);display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.btn-full{width:100%;background:var(--accent);color:#000;border:none;padding:10px;font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;cursor:pointer;border-radius:5px;transition:opacity .2s;}
.btn-full:hover{opacity:.85;}
.btn-full.sec{background:#2a2a2a;color:var(--text-dim);font-size:.8rem;font-family:'Noto Sans JP',sans-serif;letter-spacing:0;padding:8px;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:#161616;border:1px solid #2a2a2a;border-radius:10px;padding:20px;width:360px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;}
.modal h3{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px;color:var(--accent);margin:0;}
.modal-body{flex:1;overflow-y:auto;}
.modal-body::-webkit-scrollbar{width:3px;}
.modal-body::-webkit-scrollbar-thumb{background:#2a2a2a;}
.modal-actions{display:flex;gap:6px;margin-top:10px;flex-shrink:0;}
/* PICKER MODAL extensions */
.picker-modal{padding:14px 16px;gap:0;}
.picker-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.picker-close{background:none;border:none;color:var(--text-dim);font-size:1.1rem;cursor:pointer;padding:2px 6px;border-radius:4px;line-height:1;}
.picker-close:hover{color:#fff;}
.picker-team-row{display:flex;gap:5px;margin-bottom:7px;flex-wrap:wrap;}
.picker-select{flex:1;min-width:120px;background:#0e0e0e;border:1px solid var(--panel-border);color:var(--text);padding:6px 8px;font-family:'Noto Sans JP',sans-serif;font-size:0.75rem;border-radius:4px;outline:none;}
.picker-select:focus{border-color:var(--accent);}
.picker-search-row{display:flex;align-items:center;gap:6px;margin-bottom:8px;}
.picker-search-input{flex:1;background:#0e0e0e;border:1px solid var(--panel-border);color:var(--text);padding:7px 10px;font-family:'Noto Sans JP',sans-serif;font-size:0.82rem;border-radius:4px;outline:none;}
.picker-search-input:focus{border-color:var(--accent);}
.picker-team-badge{display:inline-block;font-size:0.6rem;background:#1a3010;color:var(--accent);border-radius:3px;padding:1px 5px;margin-left:4px;vertical-align:middle;}

/* LOADING SPINNER */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #333;border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}

/* TOAST */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--accent);color:#000;padding:9px 18px;border-radius:5px;font-weight:700;font-size:0.82rem;z-index:500;transition:transform .3s;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}

/* TRANSFERMARKT LOADING */
.tm-status{font-size:0.7rem;color:var(--text-dim);display:flex;align-items:center;gap:6px;padding:4px 0;}

/* PLACEMENT MODE TOGGLE */
.mode-btn{flex:1;background:none;border:none;color:var(--text-dim);padding:5px 4px;font-family:'Noto Sans JP',sans-serif;font-size:0.68rem;cursor:pointer;transition:all .15s;}
.mode-btn.active{background:var(--accent);color:#000;font-weight:700;}
.pos-slot-btn{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:5px;border:1px solid var(--panel-border);margin-bottom:4px;background:#0e0e0e;cursor:pointer;transition:border-color .15s;width:100%;}
.pos-slot-btn:hover{border-color:rgba(200,245,96,.4);}
.pos-slot-btn.slot-filled{border-color:rgba(200,245,96,.25);}
.pos-badge{width:34px;height:34px;border-radius:50%;background:#1a3010;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;flex-shrink:0;overflow:hidden;}
.pos-badge.empty{border-color:#333;background:rgba(0,0,0,.4);color:var(--text-dim);}
.pos-badge img{width:100%;height:100%;object-fit:cover;}

/* BENCH */
.lineup-section-label{font-size:0.6rem;letter-spacing:2px;color:var(--accent);text-transform:uppercase;font-weight:700;padding:8px 10px 4px;margin-top:2px;}
.bench-label{color:var(--accent2);}
.bench-slot{opacity:.92;}
.bench-slot .ls-icon{border-color:#2a4a5a;}
.bench-num{color:var(--accent2) !important;}
.ls-swap{background:none;border:none;color:var(--accent2);cursor:pointer;font-size:0.9rem;padding:2px 4px;border-radius:3px;transition:color .15s;flex-shrink:0;}
.ls-swap:hover{color:#fff;}

/* â”€â”€ DRAG AND DROP â”€â”€ */
.pitch-player.dragging{opacity:0.35;transform:translate(-50%,-50%) scale(0.9);}
.pitch-player.drag-over .pp-icon{box-shadow:0 0 0 3px #fff,0 0 0 5px var(--accent);transform:scale(1.15);}
.lineup-slot.drag-over{border-color:var(--accent);background:rgba(200,245,96,.08);}
.player-item.dragging-src{opacity:0.35;}
.touch-ghost{position:fixed;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);filter:drop-shadow(0 4px 12px rgba(0,0,0,.8));}
@keyframes pulse-ring{from{box-shadow:0 0 0 2px var(--accent);}to{box-shadow:0 0 0 5px var(--accent),0 0 10px var(--accent);}}

/* â”€â”€ OPPONENT MODE â”€â”€ */
.pitch-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;flex:1;min-width:0;height:100%;position:relative;cursor:default;padding:4px 2px;}
.pitch-area.opponent-mode .pitch-container{cursor:pointer;}
.pitch-container-label{font-family:'Bebas Neue',sans-serif;font-size:0.78rem;letter-spacing:3px;color:rgba(255,255,255,0.35);padding:3px 0;flex-shrink:0;user-select:none;transition:color .15s;display:none;}
.pitch-area.opponent-mode .pitch-container-label{display:block;}
.pitch-container.active-team .pitch-container-label{color:var(--accent);}
.pitch-area.opponent-mode .pitch-container:hover .pitch-container-label{color:rgba(255,255,255,0.65);}
/* 2ãƒãƒ¼ãƒ æ¨ªä¸¦ã³: ãƒ©ãƒ™ãƒ«åˆ†ã‚’å¼•ã„ã¦ãƒ”ãƒƒãƒã‚’åã‚ã‚‹ã€‚GKã®ä½ç½®(y=92%)ã¨ãƒãƒƒã‚¸ã‚µã‚¤ã‚ºã‚’è€ƒæ…®ã—ã¦ä½™ç™½ã‚’ç¢ºä¿ */
.pitch-area.opponent-mode .pitch-container{justify-content:center;padding:2px;}
.pitch-area.opponent-mode .pitch-wrap{max-width:100%;width:auto;height:calc(100% - 28px);max-height:100%;}
.pitch-area.opponent-mode{gap:0;align-items:stretch;}

/* â”€â”€ TEAM TABS â”€â”€ */
.team-tabs{display:none;gap:4px;margin-bottom:8px;}
.team-tabs.visible{display:flex;}
.team-tab{flex:1;padding:5px;background:#0e0e0e;border:1px solid var(--panel-border);color:var(--text-dim);font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:2px;cursor:pointer;border-radius:3px;transition:all .15s;text-align:center;}
.team-tab.active{background:var(--accent);color:#000;border-color:var(--accent);}
.team-tab.away-tab.active{background:var(--accent2);color:#000;border-color:var(--accent2);}

/* â”€â”€ ACTIVE HEADER BUTTON â”€â”€ */
.header-btn.btn-active{background:var(--accent);color:#000;border-color:var(--accent);}

/* â”€â”€ MOBILE: OPPONENT STACKED â”€â”€ */
@media (max-width: 768px) {
  .pitch-area.opponent-mode{flex-direction:column;height:auto;overflow-y:visible;}
  .pitch-area.opponent-mode .pitch-container{width:100%;height:auto;border-bottom:1px solid #1a1a1a;}
  .pitch-area.opponent-mode .pitch-container:last-child{border-bottom:none;}
  .pitch-area.opponent-mode .pitch-wrap{max-width:none;width:min(100%,calc(100vw * 7/11));height:auto;max-height:80vw;}
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<header>
  <h1>LINEUP BUILDER</h1>
  <span class="subtitle">ã‚¹ã‚¿ãƒ¡ãƒ³é…ç½®ãƒ„ãƒ¼ãƒ«</span>
  <div class="spacer"></div>
  <button class="header-btn" onclick="clearLineup()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
  <button class="header-btn" onclick="flipPitch()" title="æ”»æ’ƒæ–¹å‘ã‚’åè»¢">ğŸ”„ åè»¢</button>
  <button class="header-btn" onclick="showShareModal()">ğŸ”— ã‚·ã‚§ã‚¢</button>
  <button class="header-btn" id="opponentBtn" onclick="toggleOpponent()">âš”ï¸ å¯¾æˆ¦ç›¸æ‰‹</button>
  <button class="header-btn" onclick="exportPNG()">ğŸ“¸ ä¿å­˜</button>
  <label class="header-btn" title="ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼" style="cursor:pointer;display:flex;align-items:center;gap:4px;padding:4px 10px;">
    ğŸ¨ <input type="color" id="teamColorPicker" value="#c8f560" oninput="currentTeamColor=this.value;applyTeamColor();" style="width:20px;height:20px;border:none;padding:0;background:none;cursor:pointer;vertical-align:middle;">
  </label>
  <button class="header-btn" onclick="showQR()" id="qrBtn" style="display:none">ğŸ“± QR</button>
</header>

<div class="app">
  <!-- ===== LEFT ===== -->
  <div class="left-panel">
    <div class="panel-section">
      <div class="panel-label">ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div>
      <div class="formation-grid" id="formationGrid"></div>
    </div>

    <div class="panel-section">
      <div class="panel-label">ãƒãƒ¼ãƒ é¸æŠ</div>
      <div class="team-select-row" style="margin-bottom:6px;">
        <select id="leagueSelect" onchange="loadLeague()">
          <option value="">-- ãƒªãƒ¼ã‚°ã‚’é¸ã¶ --</option>
        </select>
      </div>
      <div class="team-select-row">
        <select id="teamSelect" onchange="loadTeam()">
          <option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>
        </select>
      </div>
      <div class="tm-status" id="tmStatus"></div>
    </div>

    <!-- CUSTOM PLAYER -->
    <div class="custom-panel">
      <div class="panel-label">ã‚«ã‚¹ã‚¿ãƒ é¸æ‰‹</div>
      <div class="custom-tabs">
        <button class="custom-tab active" onclick="switchCustomTab('search')">ğŸ” æ¤œç´¢</button>
        <button class="custom-tab" onclick="switchCustomTab('upload')">ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <button class="custom-tab" onclick="switchCustomTab('manage')">âš™ï¸ ç®¡ç†</button>
      </div>

      <!-- SEARCH TAB -->
      <div class="custom-tab-content active" id="tab-search">
        <div class="search-row">
          <input type="text" id="customName" placeholder="åå‰ã‚’å…¥åŠ›..." />
          <button class="btn-xs" onclick="searchPlayerImage()" id="searchBtn">æ¤œç´¢</button>
        </div>
        <div class="img-results" id="searchResults"></div>
        <div class="custom-note" id="searchNote"></div>
        <div id="customPreviewRow" style="display:none;">
          <div class="custom-preview-row">
            <div class="p-avatar" id="customPreviewAvatar">ğŸ‘¤</div>
            <div style="flex:1">
              <input type="text" id="customNameConfirm" placeholder="è¡¨ç¤ºå" style="margin-bottom:4px;"/>
            </div>
          </div>
          <div class="custom-form-row">
            <input type="text" id="customPos" placeholder="ãƒã‚¸ã‚·ãƒ§ãƒ³ (GK/DF/MF/FW)" />
            <input type="text" id="customNum" placeholder="#" style="width:40px;" />
            <button class="btn-xs" onclick="addCustomPlayer()">è¿½åŠ </button>
          </div>
        </div>
      </div>

      <!-- UPLOAD TAB -->
      <div class="custom-tab-content" id="tab-upload">
        <div class="search-row">
          <input type="text" id="uploadName" placeholder="é¸æ‰‹å" />
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
          <label class="upload-label">
            ğŸ“ ç”»åƒã‚’é¸æŠ
            <input type="file" id="uploadFile" accept="image/*" onchange="handleUpload()">
          </label>
          <div id="uploadPreview" style="width:44px;height:44px;border-radius:50%;background:#1a1a1a;border:2px solid #2a2a2a;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">ğŸ‘¤</div>
        </div>
        <div class="custom-form-row">
          <input type="text" id="uploadPos" placeholder="ãƒã‚¸ã‚·ãƒ§ãƒ³" />
          <input type="text" id="uploadNum" placeholder="#" style="width:40px;" />
          <button class="btn-xs" onclick="addUploadPlayer()">è¿½åŠ </button>
        </div>
      </div>

      <!-- MANAGE TAB -->
      <div class="custom-tab-content" id="tab-manage">
        <div id="customPlayerManageList" style="max-height:140px;overflow-y:auto;"></div>
        <div class="custom-note" style="margin-top:4px;">ç™»éŒ²æ¸ˆã¿ã‚«ã‚¹ã‚¿ãƒ é¸æ‰‹ã‚’ç®¡ç†</div>
      </div>
    </div>

    <!-- PLAYER LIST -->
    <div style="padding:8px 14px 4px;flex-shrink:0;">
      <input type="text" class="player-search-input" id="playerSearchInput" placeholder="ğŸ” åå‰ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ»èƒŒç•ªå·..." oninput="filterPlayerList()">
    </div>
    <!-- é…ç½®ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
    <div style="display:flex;gap:4px;padding:5px 10px 6px;border-bottom:1px solid var(--panel-border);">
      <span style="font-size:0.6rem;color:var(--text-dim);letter-spacing:1px;align-self:center;flex-shrink:0;">é…ç½®</span>
      <div style="display:flex;flex:1;background:#0e0e0e;border:1px solid var(--panel-border);border-radius:4px;overflow:hidden;">
        <button id="modePlayerFirst" class="mode-btn active" onclick="setPlacementMode('player')">ğŸ‘¤ é¸æ‰‹ã‹ã‚‰</button>
        <button id="modePosFirst" class="mode-btn" onclick="setPlacementMode('position')">ğŸ“ ãƒã‚¸ã‚·ãƒ§ãƒ³ã‹ã‚‰</button>
      </div>
    </div>
    <!-- é¸æ‰‹ä¸€è¦§ï¼ˆé¸æ‰‹ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div id="playerPickerPanel" style="flex:1;min-height:0;display:flex;flex-direction:column;">
      <div class="player-list-wrap" id="playerList">
        <div style="color:var(--text-dim);font-size:0.78rem;padding:8px;text-align:center;">ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
    </div>
    <!-- ãƒã‚¸ã‚·ãƒ§ãƒ³ä¸€è¦§ï¼ˆãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div id="positionPickerPanel" style="flex:1;min-height:0;display:none;flex-direction:column;">
      <div class="player-list-wrap" id="positionList" style="flex:1;overflow-y:auto;padding:6px;"></div>
    </div>
  </div>

  <!-- ===== PITCH ===== -->
  <div class="pitch-area" id="pitchArea">
    <!-- HOME TEAM -->
    <div class="pitch-container active-team" id="homeContainer" onclick="setActiveTeamClick('home')">
      <div class="pitch-container-label" id="homeLabel">HOME</div>
      <div class="pitch-wrap" id="pitchWrap">
        <svg class="pitch-svg" viewBox="0 0 700 1100" xmlns="http://www.w3.org/2000/svg">
          <rect width="700" height="1100" fill="#2a5c14"/>
          <rect x="0" y="0" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="220" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="440" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="660" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="880" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="28" y="28" width="644" height="1044" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="3"/>
          <line x1="28" y1="550" x2="672" y2="550" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="550" r="91" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="550" r="4" fill="rgba(255,255,255,.55)"/>
          <rect x="175" y="28" width="350" height="178" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <rect x="252" y="28" width="196" height="78" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="152" r="4" fill="rgba(255,255,255,.55)"/>
          <rect x="175" y="894" width="350" height="178" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <rect x="252" y="994" width="196" height="78" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="948" r="4" fill="rgba(255,255,255,.55)"/>
          <rect x="272" y="0" width="156" height="28" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="2"/>
          <rect x="272" y="1072" width="156" height="28" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="2"/>
          <path d="M28,28 A18,18 0 0,1 46,46" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
          <path d="M672,28 A18,18 0 0,0 654,46" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
          <path d="M28,1072 A18,18 0 0,0 46,1054" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
          <path d="M672,1072 A18,18 0 0,1 654,1054" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
        </svg>
        <div class="pitch-players" id="pitchPlayers"></div>
      </div>
    </div>
    <!-- AWAY TEAM (hidden by default) -->
    <div class="pitch-container" id="awayContainer" style="display:none" onclick="setActiveTeamClick('away')">
      <div class="pitch-container-label" id="awayLabel">AWAY</div>
      <div class="pitch-wrap" id="opponentPitchWrap">
        <svg class="pitch-svg" viewBox="0 0 700 1100" xmlns="http://www.w3.org/2000/svg">
          <rect width="700" height="1100" fill="#2a5c14"/>
          <rect x="0" y="0" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="220" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="440" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="660" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="0" y="880" width="700" height="110" fill="#306818" opacity=".7"/>
          <rect x="28" y="28" width="644" height="1044" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="3"/>
          <line x1="28" y1="550" x2="672" y2="550" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="550" r="91" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="550" r="4" fill="rgba(255,255,255,.55)"/>
          <rect x="175" y="28" width="350" height="178" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <rect x="252" y="28" width="196" height="78" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="152" r="4" fill="rgba(255,255,255,.55)"/>
          <rect x="175" y="894" width="350" height="178" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <rect x="252" y="994" width="196" height="78" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
          <circle cx="350" cy="948" r="4" fill="rgba(255,255,255,.55)"/>
          <rect x="272" y="0" width="156" height="28" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="2"/>
          <rect x="272" y="1072" width="156" height="28" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="2"/>
          <path d="M28,28 A18,18 0 0,1 46,46" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
          <path d="M672,28 A18,18 0 0,0 654,46" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
          <path d="M28,1072 A18,18 0 0,0 46,1054" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
          <path d="M672,1072 A18,18 0 0,1 654,1054" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
        </svg>
        <div class="pitch-players" id="opponentPitchPlayers"></div>
      </div>
    </div>
  </div>

  <!-- ===== RIGHT ===== -->
  <div class="right-panel">
    <div class="panel-section">
      <div class="team-tabs" id="teamTabs">
        <button class="team-tab active" id="homeTab" onclick="setActiveTeam('home')">HOME</button>
        <button class="team-tab away-tab" id="awayTab" onclick="setActiveTeam('away')">AWAY</button>
      </div>
      <div class="panel-label">ã‚¹ã‚¿ãƒ¡ãƒ³ãƒ»ãƒ™ãƒ³ãƒ</div>
      <div style="font-size:0.68rem;color:var(--text-dim);line-height:1.4;" id="lineupCount">ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ 0/11äººã€€ãƒ™ãƒ³ãƒ 0/5äºº</div>
    </div>
    <div class="lineup-scroll" id="lineupList"></div>
    <div class="lineup-actions">
      <button class="btn-full" onclick="exportPNG()">ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜</button>
      <div style="display:flex;gap:4px;">
        <button class="btn-full sec" onclick="openSaveModal()" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
        <button class="btn-full sec" onclick="openLoadModal()" style="flex:1;">ğŸ“‚ èª­ã¿è¾¼ã¿</button>
      </div>
      <button class="btn-full sec" onclick="clearLineup()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
    </div>
  </div>
</div>


<!-- QR CODE MODAL -->
<div class="modal-overlay" id="qrModal">
  <div class="modal" style="align-items:center;max-width:320px;">
    <h3>ğŸ“± ã‚¹ãƒãƒ›ã§ãƒ†ã‚¹ãƒˆ</h3>
    <div class="modal-body" style="text-align:center;padding:10px 0;">
      <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:12px;">ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
      <div id="qrCodeArea" style="width:200px;height:200px;margin:0 auto;background:#fff;display:flex;align-items:center;justify-content:center;border-radius:8px;"></div>
      <p id="qrUrlText" style="font-size:0.68rem;color:var(--text-dim);margin-top:8px;word-break:break-all;"></p>
      <hr style="border-color:#333;margin:12px 0;">
      <p style="font-size:0.8rem;color:var(--accent);font-weight:700;margin-bottom:6px;">ğŸ’¡ ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•</p>
      <p style="font-size:0.72rem;color:var(--text-dim);line-height:1.6;">
        1. PC ã§ <code style="background:#1a1a1a;padding:2px 5px;border-radius:3px;">python -m http.server 8080</code> ã‚’å®Ÿè¡Œ<br>
        2. PCã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªï¼ˆä¾‹: 192.168.1.5ï¼‰<br>
        3. ã‚¹ãƒãƒ›ã§ <code style="background:#1a1a1a;padding:2px 5px;border-radius:3px;">http://192.168.1.5:8080/</code> ã‚’é–‹ã<br>
        â€» PCã¨ã‚¹ãƒãƒ›ãŒåŒã˜Wi-Fiã«ç¹‹ãŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
      </p>
    </div>
    <div class="modal-actions">
      <button class="btn-xs sec" style="flex:1;" onclick="document.getElementById('qrModal').classList.remove('open')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>
<!-- SLOT MODAL - player picker with team/league filter -->
<div class="modal-overlay" id="slotModal">
  <div class="modal picker-modal">
    <div class="picker-header">
      <h3 id="modalTitle">é¸æ‰‹ã‚’é…ç½®</h3>
      <button class="picker-close" onclick="closeModal()">âœ•</button>
    </div>
    <!-- Team selector inside modal -->
    <div class="picker-team-row" id="pickerTeamRow">
      <select id="pickerLeagueSelect" onchange="onPickerLeagueChange()" class="picker-select">
        <option value="">-- ãƒªãƒ¼ã‚°ã‚’é¸ã¶ --</option>
      </select>
      <select id="pickerTeamSelect" onchange="onPickerTeamChange()" class="picker-select" style="display:none;">
        <option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>
      </select>
    </div>
    <!-- Name search (cross-team) -->
    <div class="picker-search-row">
      <input type="text" id="modalSearch" placeholder="ğŸ” åå‰ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³(GK/FW)ãƒ»èƒŒç•ªå·..." oninput="filterModal()" class="picker-search-input">
      <span id="pickerLoadStatus" style="font-size:0.65rem;color:var(--text-dim);white-space:nowrap;"></span>
    </div>
    <div class="modal-body" id="modalPlayerList"></div>
    <div class="modal-actions">
      <button class="btn-xs sec" style="flex:1;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>


<!-- SAVE MODAL -->
<div class="modal-overlay" id="saveModal">
  <div class="modal" style="max-width:320px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h3 style="margin:0;">ğŸ’¾ ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ã‚’ä¿å­˜</h3>
      <button class="picker-close" onclick="document.getElementById('saveModal').classList.remove('open')">âœ•</button>
    </div>
    <input type="text" id="saveNameInput" placeholder="åå‰ã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒ‰ãƒªãƒ¼ãƒ ãƒãƒ¼ãƒ ï¼‰" style="margin-bottom:10px;">
    <div id="saveSlotList" class="modal-body" style="max-height:200px;"></div>
    <div class="modal-actions">
      <button class="btn-xs" onclick="doSaveLineup()" style="flex:1;">ä¿å­˜ã™ã‚‹</button>
      <button class="btn-xs sec" onclick="document.getElementById('saveModal').classList.remove('open')" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- LOAD MODAL -->
<div class="modal-overlay" id="loadModal">
  <div class="modal" style="max-width:320px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h3 style="margin:0;">ğŸ“‚ ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿</h3>
      <button class="picker-close" onclick="document.getElementById('loadModal').classList.remove('open')">âœ•</button>
    </div>
    <div id="loadSlotList" class="modal-body" style="max-height:260px;"></div>
    <div class="modal-actions">
      <button class="btn-xs sec" onclick="document.getElementById('loadModal').classList.remove('open')" style="flex:1;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="modal-overlay" id="shareModal">
  <div class="modal" style="max-width:340px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h3 style="margin:0;">ğŸ”— ã‚·ã‚§ã‚¢URL</h3>
      <button class="picker-close" onclick="document.getElementById('shareModal').classList.remove('open')">âœ•</button>
    </div>
    <div style="text-align:center;margin-bottom:12px;">
      <img id="shareQRImg" src="" width="160" height="160" style="border-radius:8px;background:#fff;">
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px;">
      <input type="text" id="shareUrlText" readonly style="flex:1;font-size:0.65rem;padding:6px 8px;">
      <button class="btn-xs" onclick="copyShareURL()" style="flex-shrink:0;">ã‚³ãƒ”ãƒ¼</button>
    </div>
    <p style="font-size:0.65rem;color:var(--text-dim);margin:0;">â€» é¸æ‰‹åãƒ»ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼ã‚’URLã«å«ã¿ã¾ã™ã€‚</p>
    <div class="modal-actions">
      <button class="btn-xs sec" style="flex:1;" onclick="document.getElementById('shareModal').classList.remove('open')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// ============================================================
// DATA: FORMATIONS
// ============================================================
const FORMATIONS = {
  // â”€â”€ 4ãƒãƒƒã‚¯ç³» â”€â”€
  "4-4-2":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"RM",x:80,y:55},{role:"CM",x:60,y:57},{role:"CM",x:40,y:57},{role:"LM",x:20,y:55},
    {role:"ST",x:38,y:32},{role:"ST",x:62,y:32}]},
  "4-2-2-2":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:62,y:64},{role:"DM",x:38,y:64},
    {role:"RM",x:78,y:48},{role:"LM",x:22,y:48},
    {role:"ST",x:38,y:30},{role:"ST",x:62,y:30}]},
  "4-2-4":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:62,y:60},{role:"DM",x:38,y:60},
    {role:"RW",x:82,y:32},{role:"SS",x:60,y:28},{role:"SS",x:40,y:28},{role:"LW",x:18,y:32}]},
  "4-1-2-3":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:50,y:65},
    {role:"CM",x:68,y:53},{role:"CM",x:32,y:53},
    {role:"RW",x:80,y:32},{role:"CF",x:50,y:27},{role:"LW",x:20,y:32}]},
  "4-3-3":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:50,y:64},{role:"CM",x:72,y:54},{role:"CM",x:28,y:54},
    {role:"RW",x:80,y:32},{role:"CF",x:50,y:26},{role:"LW",x:20,y:32}]},
  "4-3-2-1":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"CM",x:70,y:60},{role:"CM",x:50,y:58},{role:"CM",x:30,y:60},
    {role:"SS",x:65,y:42},{role:"SS",x:35,y:42},
    {role:"CF",x:50,y:27}]},
  "4-2-3-1":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:62,y:63},{role:"DM",x:38,y:63},
    {role:"RMF",x:78,y:46},{role:"OMF",x:50,y:44},{role:"LMF",x:22,y:46},
    {role:"CF",x:50,y:27}]},
  "4-1-4-1":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:50,y:64},
    {role:"RM",x:82,y:50},{role:"CM",x:62,y:52},{role:"CM",x:38,y:52},{role:"LM",x:18,y:50},
    {role:"CF",x:50,y:27}]},
  "4-3-1-2":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"CM",x:70,y:60},{role:"CM",x:50,y:62},{role:"CM",x:30,y:60},
    {role:"OM",x:50,y:45},
    {role:"ST",x:65,y:30},{role:"ST",x:35,y:30}]},
  "4-5-1":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"RM",x:84,y:53},{role:"CM",x:67,y:55},{role:"CM",x:50,y:53},{role:"CM",x:33,y:55},{role:"LM",x:16,y:53},
    {role:"CF",x:50,y:27}]},
  "4-4-2â—†":{positions:[
    {role:"GK",x:50,y:92},{role:"RB",x:80,y:76},{role:"CB",x:62,y:78},{role:"CB",x:38,y:78},{role:"LB",x:20,y:76},
    {role:"DM",x:50,y:64},{role:"RM",x:80,y:52},{role:"LM",x:20,y:52},{role:"OM",x:50,y:42},
    {role:"ST",x:38,y:28},{role:"ST",x:62,y:28}]},
  // â”€â”€ 3ãƒãƒƒã‚¯ç³» â”€â”€
  "3-4-2-1":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:70,y:78},{role:"CB",x:50,y:80},{role:"CB",x:30,y:78},
    {role:"RWB",x:84,y:60},{role:"CM",x:64,y:58},{role:"CM",x:36,y:58},{role:"LWB",x:16,y:60},
    {role:"SS",x:65,y:42},{role:"SS",x:35,y:42},
    {role:"CF",x:50,y:27}]},
  "3-4-1-2":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:70,y:78},{role:"CB",x:50,y:80},{role:"CB",x:30,y:78},
    {role:"RWB",x:84,y:60},{role:"CM",x:64,y:58},{role:"CM",x:36,y:58},{role:"LWB",x:16,y:60},
    {role:"OM",x:50,y:44},
    {role:"ST",x:65,y:29},{role:"ST",x:35,y:29}]},
  "3-2-2-3":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:68,y:79},{role:"CB",x:50,y:81},{role:"CB",x:32,y:79},
    {role:"DM",x:63,y:66},{role:"DM",x:37,y:66},
    {role:"RM",x:78,y:50},{role:"LM",x:22,y:50},
    {role:"RW",x:78,y:32},{role:"CF",x:50,y:27},{role:"LW",x:22,y:32}]},
  "3-5-2":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:70,y:77},{role:"CB",x:50,y:80},{role:"CB",x:30,y:77},
    {role:"RWB",x:85,y:59},{role:"CM",x:67,y:54},{role:"CM",x:50,y:51},{role:"CM",x:33,y:54},{role:"LWB",x:15,y:59},
    {role:"ST",x:38,y:32},{role:"ST",x:62,y:32}]},
  "3-3-3-1":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:70,y:79},{role:"CB",x:50,y:81},{role:"CB",x:30,y:79},
    {role:"CM",x:70,y:63},{role:"CM",x:50,y:63},{role:"CM",x:30,y:63},
    {role:"RW",x:78,y:44},{role:"SS",x:50,y:42},{role:"LW",x:22,y:44},
    {role:"CF",x:50,y:27}]},
  "3-5-1-1":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:70,y:77},{role:"CB",x:50,y:80},{role:"CB",x:30,y:77},
    {role:"RWB",x:85,y:59},{role:"CM",x:67,y:54},{role:"CM",x:50,y:51},{role:"CM",x:33,y:54},{role:"LWB",x:15,y:59},
    {role:"SS",x:50,y:40},
    {role:"CF",x:50,y:27}]},
  // â”€â”€ 5ãƒãƒƒã‚¯ç³» â”€â”€
  "5-3-2":{positions:[
    {role:"GK",x:50,y:92},{role:"RWB",x:85,y:74},{role:"CB",x:68,y:78},{role:"CB",x:50,y:80},{role:"CB",x:32,y:78},{role:"LWB",x:15,y:74},
    {role:"CM",x:67,y:55},{role:"CM",x:50,y:52},{role:"CM",x:33,y:55},
    {role:"ST",x:38,y:31},{role:"ST",x:62,y:31}]},
  "5-3-1-1":{positions:[
    {role:"GK",x:50,y:92},{role:"RWB",x:85,y:74},{role:"CB",x:68,y:78},{role:"CB",x:50,y:80},{role:"CB",x:32,y:78},{role:"LWB",x:15,y:74},
    {role:"CM",x:67,y:55},{role:"CM",x:50,y:52},{role:"CM",x:33,y:55},
    {role:"SS",x:50,y:40},
    {role:"CF",x:50,y:27}]},
  "5-4-1":{positions:[
    {role:"GK",x:50,y:92},{role:"RWB",x:85,y:74},{role:"CB",x:68,y:78},{role:"CB",x:50,y:80},{role:"CB",x:32,y:78},{role:"LWB",x:15,y:74},
    {role:"RM",x:80,y:55},{role:"CM",x:60,y:57},{role:"CM",x:40,y:57},{role:"LM",x:20,y:55},
    {role:"CF",x:50,y:28}]},
  "5-3-1-1B":{positions:[
    {role:"GK",x:50,y:92},{role:"RWB",x:85,y:74},{role:"CB",x:68,y:78},{role:"CB",x:50,y:80},{role:"CB",x:32,y:78},{role:"LWB",x:15,y:74},
    {role:"CM",x:67,y:56},{role:"DM",x:50,y:63},{role:"CM",x:33,y:56},
    {role:"OM",x:50,y:44},
    {role:"CF",x:50,y:28}]},
  // â”€â”€ ãã®ä»– â”€â”€
  "2-3-5":{positions:[
    {role:"GK",x:50,y:92},{role:"CB",x:65,y:81},{role:"CB",x:35,y:81},
    {role:"CM",x:70,y:65},{role:"CM",x:50,y:63},{role:"CM",x:30,y:65},
    {role:"RW",x:88,y:36},{role:"CF",x:68,y:28},{role:"CF",x:50,y:26},{role:"CF",x:32,y:28},{role:"LW",x:12,y:36}]},
};

// ============================================================
// DATA: LEAGUES & TEAMS (Transfermarkt IDs for image fetching)
// ============================================================
// ============================================================
// TEAM DATA: ESPN API IDs
// Roster API: https://site.api.espn.com/apis/site/v2/sports/soccer/{league}/teams/{id}/roster
// Photo:      https://a.espncdn.com/i/headshots/soccer/players/full/{player_id}.png
// ============================================================
const LEAGUES = {
  "J1ãƒªãƒ¼ã‚°": {
    "æµ¦å’Œãƒ¬ãƒƒã‚º":        {id:"3961", league:"jpn.1"},
    "é¹¿å³¶ã‚¢ãƒ³ãƒˆãƒ©ãƒ¼ã‚º":  {id:"3963", league:"jpn.1"},
    "æ¨ªæµœFãƒ»ãƒãƒªãƒã‚¹":   {id:"3966", league:"jpn.1"},
    "FCæ±äº¬":           {id:"3962", league:"jpn.1"},
    "å·å´ãƒ•ãƒ­ãƒ³ã‚¿ãƒ¼ãƒ¬":  {id:"3964", league:"jpn.1"},
    "ã‚¬ãƒ³ãƒå¤§é˜ª":        {id:"3965", league:"jpn.1"},
    "ã‚»ãƒ¬ãƒƒã‚½å¤§é˜ª":      {id:"3967", league:"jpn.1"},
    "ã‚µãƒ³ãƒ•ãƒ¬ãƒƒãƒã‚§åºƒå³¶": {id:"3968", league:"jpn.1"},
    "åå¤å±‹ã‚°ãƒ©ãƒ³ãƒ‘ã‚¹":  {id:"3969", league:"jpn.1"},
    "ãƒ´ã‚£ãƒƒã‚»ãƒ«ç¥æˆ¸":    {id:"3970", league:"jpn.1"},
    "æŸãƒ¬ã‚¤ã‚½ãƒ«":        {id:"3971", league:"jpn.1"},
    "ã‚¢ãƒ“ã‚¹ãƒ‘ç¦å²¡":      {id:"3972", league:"jpn.1"},
    "æ¹˜å—ãƒ™ãƒ«ãƒãƒ¼ãƒ¬":    {id:"3973", league:"jpn.1"},
    "ã‚¢ãƒ«ãƒ“ãƒ¬ãƒƒã‚¯ã‚¹æ–°æ½Ÿ": {id:"3974", league:"jpn.1"},
    "åŒ—æµ·é“ã‚³ãƒ³ã‚µãƒ‰ãƒ¼ãƒ¬æœ­å¹Œ": {id:"3975", league:"jpn.1"},
    "äº¬éƒ½ã‚µãƒ³ã‚¬":        {id:"3976", league:"jpn.1"},
    "æ±äº¬ãƒ´ã‚§ãƒ«ãƒ‡ã‚£":    {id:"3977", league:"jpn.1"},
    "ã‚¸ãƒ¥ãƒ“ãƒ­ç£ç”°":      {id:"3978", league:"jpn.1"},
    "æ¸…æ°´ã‚¨ã‚¹ãƒ‘ãƒ«ã‚¹":    {id:"3979", league:"jpn.1"},
    "æ¨ªæµœFC":           {id:"3980", league:"jpn.1"},
  },
  "ãƒ—ãƒ¬ãƒŸã‚¢ãƒªãƒ¼ã‚°": {
    "ãƒãƒ³ãƒã‚§ã‚¹ã‚¿ãƒ¼C":   {id:"382",  league:"eng.1"},
    "ã‚¢ãƒ¼ã‚»ãƒŠãƒ«":        {id:"359",  league:"eng.1"},
    "ãƒªãƒ´ã‚¡ãƒ—ãƒ¼ãƒ«":      {id:"364",  league:"eng.1"},
    "ãƒã‚§ãƒ«ã‚·ãƒ¼":        {id:"363",  league:"eng.1"},
    "ãƒãƒ³ãƒã‚§ã‚¹ã‚¿ãƒ¼U":   {id:"360",  league:"eng.1"},
    "ãƒˆãƒƒãƒ†ãƒŠãƒ ":        {id:"367",  league:"eng.1"},
    "ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒƒã‚¹ãƒ«":    {id:"361",  league:"eng.1"},
    "ã‚¢ã‚¹ãƒˆãƒ³ãƒ»ãƒ´ã‚£ãƒ©":  {id:"362",  league:"eng.1"},
    "ã‚¦ã‚§ã‚¹ãƒˆãƒãƒ ":      {id:"371",  league:"eng.1"},
    "ãƒ–ãƒ©ã‚¤ãƒˆãƒ³":        {id:"331",  league:"eng.1"},
    "ãƒ•ãƒ©ãƒ ":           {id:"370",  league:"eng.1"},
    "ã‚¦ã‚©ãƒ«ãƒ´ã‚¡ãƒ¼ãƒãƒ³ãƒ—ãƒˆãƒ³": {id:"380", league:"eng.1"},
    "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ‘ãƒ¬ã‚¹":  {id:"384",  league:"eng.1"},
    "ãƒ–ãƒ¬ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ‰":  {id:"397",  league:"eng.1"},
    "ã‚¨ãƒ´ã‚¡ãƒ¼ãƒˆãƒ³":      {id:"368",  league:"eng.1"},
    "ãƒœãƒ¼ãƒ³ãƒã‚¹":        {id:"349",  league:"eng.1"},
    "ãƒãƒƒãƒ†ã‚£ãƒ³ã‚¬ãƒ ãƒ»ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ": {id:"393", league:"eng.1"},
    "ã‚¤ãƒ—ã‚¹ã‚¦ã‚£ãƒƒãƒ":    {id:"394",  league:"eng.1"},
    "ãƒ¬ã‚¹ã‚¿ãƒ¼":          {id:"375",  league:"eng.1"},
    "ã‚µã‚¦ã‚µãƒ³ãƒ—ãƒˆãƒ³":    {id:"376",  league:"eng.1"},
  },
  "ãƒ©ãƒ»ãƒªãƒ¼ã‚¬": {
    "ãƒãƒ«ã‚»ãƒ­ãƒŠ":        {id:"83",   league:"esp.1"},
    "ãƒ¬ã‚¢ãƒ«ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰": {id:"86",  league:"esp.1"},
    "ã‚¢ãƒˆãƒ¬ãƒ†ã‚£ã‚³ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰": {id:"1068", league:"esp.1"},
    "ã‚»ãƒ“ãƒ¼ã‚¸ãƒ£":        {id:"243",  league:"esp.1"},
    "ãƒ“ã‚¸ãƒ£ãƒ¬ã‚¢ãƒ«":      {id:"449",  league:"esp.1"},
    "ãƒ¬ã‚¢ãƒ«ãƒ»ã‚½ã‚·ã‚¨ãƒ€":  {id:"541",  league:"esp.1"},
    "ãƒ™ãƒ†ã‚£ã‚¹":          {id:"244",  league:"esp.1"},
    "ã‚¢ã‚¹ãƒ¬ãƒ†ã‚£ãƒƒã‚¯ãƒ»ã‚¯ãƒ«ãƒ–": {id:"93", league:"esp.1"},
    "ãƒãƒ¬ãƒ³ã‚·ã‚¢":        {id:"94",   league:"esp.1"},
    "ã‚ªã‚µã‚¹ãƒŠ":          {id:"245",  league:"esp.1"},
    "ã‚¸ãƒ­ãƒ¼ãƒŠ":          {id:"9812", league:"esp.1"},
    "ãƒã‚¸ãƒ§ãƒ«ã‚«":        {id:"97",   league:"esp.1"},
    "ã‚¢ãƒ©ãƒ™ã‚¹":          {id:"559",  league:"esp.1"},
    "ãƒ©ã‚¹ãƒ»ãƒ‘ãƒ«ãƒã‚¹":    {id:"248",  league:"esp.1"},
    "ãƒ¬ã‚¬ãƒã‚¹":          {id:"558",  league:"esp.1"},
    "ã‚²ã‚¿ãƒ•ã‚§":          {id:"98",   league:"esp.1"},
    "ãƒ©ãƒ¼ã‚¸ãƒ§":          {id:"101",  league:"esp.1"},
    "ã‚»ãƒ«ã‚¿":            {id:"246",  league:"esp.1"},
    "ã‚¨ã‚¹ãƒ‘ãƒ‹ãƒ§ãƒ¼ãƒ«":    {id:"88",   league:"esp.1"},
    "ãƒã‚¸ãƒ£ãƒ‰ãƒªãƒ¼ãƒ‰":    {id:"102",  league:"esp.1"},
  },
  "ãƒ–ãƒ³ãƒ‡ã‚¹ãƒªãƒ¼ã‚¬": {
    "ãƒã‚¤ã‚¨ãƒ«ãƒ³ãƒ»ãƒŸãƒ¥ãƒ³ãƒ˜ãƒ³": {id:"132", league:"ger.1"},
    "ãƒœãƒ«ã‚·ã‚¢ãƒ»ãƒ‰ãƒ«ãƒˆãƒ ãƒ³ãƒˆ": {id:"124", league:"ger.1"},
    "RBãƒ©ã‚¤ãƒ—ãƒ„ã‚£ãƒ’":   {id:"11420", league:"ger.1"},
    "ãƒ¬ãƒãƒ¼ã‚¯ãƒ¼ã‚¼ãƒ³":    {id:"131",  league:"ger.1"},
    "ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ":   {id:"1877", league:"ger.1"},
    "ã‚·ãƒ¥ãƒˆã‚¥ãƒƒãƒˆã‚¬ãƒ«ãƒˆ": {id:"161", league:"ger.1"},
    "ãƒ´ã‚©ãƒ«ãƒ•ã‚¹ãƒ–ãƒ«ã‚¯": {id:"160",  league:"ger.1"},
    "ãƒ›ãƒƒãƒ•ã‚§ãƒ³ãƒã‚¤ãƒ ": {id:"169",  league:"ger.1"},
    "ãƒ•ãƒ©ã‚¤ãƒ–ãƒ«ã‚¯":     {id:"136",  league:"ger.1"},
    "ã‚¢ã‚¦ã‚¯ã‚¹ãƒ–ãƒ«ã‚¯":   {id:"1879", league:"ger.1"},
    "ãƒœãƒ¼ãƒ•ãƒ ":          {id:"163",  league:"ger.1"},
    "ã‚¦ãƒ‹ã‚ªãƒ³ãƒ»ãƒ™ãƒ«ãƒªãƒ³": {id:"11746", league:"ger.1"},
    "ã‚±ãƒ«ãƒ³":           {id:"163",  league:"ger.1"},
    "ãƒã‚¤ãƒ³ãƒ„":          {id:"159",  league:"ger.1"},
    "ãƒ´ã‚§ãƒ«ãƒ€ãƒ¼ãƒ»ãƒ–ãƒ¬ãƒ¼ãƒ¡ãƒ³": {id:"162", league:"ger.1"},
    "ã‚°ãƒ©ãƒ¼ãƒ‰ãƒãƒƒãƒ":   {id:"126",  league:"ger.1"},
    "ãƒã‚¤ãƒ‡ãƒ³ãƒã‚¤ãƒ ":   {id:"19767", league:"ger.1"},
    "ã‚¶ãƒ³ã‚¯ãƒˆãƒ»ãƒ‘ã‚¦ãƒª": {id:"135",  league:"ger.1"},
  },
  "ã‚»ãƒªã‚¨A": {
    "ã‚¤ãƒ³ãƒ†ãƒ«":          {id:"110",  league:"ita.1"},
    "ãƒŸãƒ©ãƒ³":            {id:"103",  league:"ita.1"},
    "ãƒ¦ãƒ´ã‚§ãƒ³ãƒˆã‚¹":      {id:"111",  league:"ita.1"},
    "ãƒŠãƒãƒª":            {id:"3591", league:"ita.1"},
    "ãƒ­ãƒ¼ãƒ":            {id:"104",  league:"ita.1"},
    "ãƒ©ãƒ„ã‚£ã‚ª":          {id:"108",  league:"ita.1"},
    "ã‚¢ã‚¿ãƒ©ãƒ³ã‚¿":        {id:"3587", league:"ita.1"},
    "ãƒ•ã‚£ã‚ªãƒ¬ãƒ³ãƒ†ã‚£ãƒ¼ãƒŠ": {id:"106", league:"ita.1"},
    "ãƒœãƒ­ãƒ¼ãƒ‹ãƒ£":        {id:"3593", league:"ita.1"},
    "ãƒˆãƒªãƒ":            {id:"116",  league:"ita.1"},
    "ãƒ¢ãƒ³ãƒ„ã‚¡":          {id:"15030", league:"ita.1"},
    "ã‚¨ãƒ³ãƒãƒª":          {id:"3590", league:"ita.1"},
    "ã‚¦ãƒ‡ã‚£ãƒãƒ¼ã‚¼":      {id:"117",  league:"ita.1"},
    "ã‚¸ã‚§ãƒã‚¢":          {id:"107",  league:"ita.1"},
    "ã‚«ãƒªã‚¢ãƒª":          {id:"3588", league:"ita.1"},
    "ãƒ¬ãƒƒãƒã‚§":          {id:"3592", league:"ita.1"},
    "ãƒ´ã‚§ãƒ­ãƒ¼ãƒŠ":        {id:"118",  league:"ita.1"},
    "ã‚³ãƒ¢":              {id:"21853", league:"ita.1"},
    "ãƒ‘ãƒ«ãƒ":            {id:"113",  league:"ita.1"},
    "ãƒ´ã‚§ãƒãƒ„ã‚£ã‚¢":      {id:"119",  league:"ita.1"},
  },
  "ãƒªãƒ¼ã‚°ãƒ»ã‚¢ãƒ³": {
    "ãƒ‘ãƒªSG":           {id:"160",  league:"fra.1"},
    "ãƒ¢ãƒŠã‚³":            {id:"163",  league:"fra.1"},
    "ãƒãƒ«ã‚»ã‚¤ãƒ¦":        {id:"162",  league:"fra.1"},
    "ãƒ©ãƒ³ã‚¹":            {id:"3000", league:"fra.1"},
    "ãƒ‹ãƒ¼ã‚¹":            {id:"166",  league:"fra.1"},
    "ãƒªãƒ¨ãƒ³":            {id:"3003", league:"fra.1"},
    "ãƒªãƒ¼ãƒ«":            {id:"3001", league:"fra.1"},
    "ãƒ¬ãƒ³ãƒŒ":            {id:"3002", league:"fra.1"},
    "ãƒ©ãƒ³ã‚¹":            {id:"3000", league:"fra.1"},
    "ã‚¹ãƒˆãƒ©ã‚¹ãƒ–ãƒ¼ãƒ«":   {id:"3004", league:"fra.1"},
    "ãƒŠãƒ³ãƒˆ":            {id:"3005", league:"fra.1"},
    "ã‚¢ãƒ³ã‚¸ã‚§":          {id:"3006", league:"fra.1"},
    "ã‚¹ã‚¿ãƒƒãƒ‰ãƒ»ãƒ‰ã‚¥ãƒ»ãƒ©ãƒ³ã‚¹": {id:"3007", league:"fra.1"},
    "ãƒ«ãƒ»ã‚¢ãƒ¼ãƒ–ãƒ«":     {id:"3008", league:"fra.1"},
    "ã‚µãƒ³=ãƒ†ãƒ†ã‚£ã‚¨ãƒ³ãƒŒ": {id:"167",  league:"fra.1"},
    "ãƒˆã‚¥ãƒ¼ãƒ«ãƒ¼ã‚º":     {id:"168",  league:"fra.1"},
    "ã‚ªãƒ¼ã‚»ãƒ¼ãƒ«":        {id:"164",  league:"fra.1"},
    "ãƒ¢ãƒ³ãƒšãƒªã‚¨":        {id:"165",  league:"fra.1"},
    "ãƒ–ãƒ¬ã‚¹ãƒˆ":          {id:"3009", league:"fra.1"},
    "ãƒ©ãƒ³ã‚¹3":          {id:"3010", league:"fra.1"},
  },
  "ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—å‡ºå ´å›½": {
    "æ—¥æœ¬":           {id:"294",  league:"preset"},
    "ãƒ–ãƒ©ã‚¸ãƒ«":       {id:"95",   league:"preset"},
    "ãƒ•ãƒ©ãƒ³ã‚¹":       {id:"577",  league:"preset"},
    "ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³":   {id:"9",    league:"preset"},
    "ãƒ‰ã‚¤ãƒ„":         {id:"102",  league:"preset"},
    "ã‚¹ãƒšã‚¤ãƒ³":       {id:"161",  league:"preset"},
    "ã‚¤ãƒ³ã‚°ãƒ©ãƒ³ãƒ‰":   {id:"76",   league:"preset"},
    "ã‚¤ã‚¿ãƒªã‚¢":       {id:"110",  league:"preset"},
    "ãƒãƒ«ãƒˆã‚¬ãƒ«":     {id:"135",  league:"preset"},
    "ã‚ªãƒ©ãƒ³ãƒ€":       {id:"125",  league:"preset"},
    "éŸ“å›½":           {id:"297",  league:"preset"},
    "ã‚¢ãƒ¡ãƒªã‚«":       {id:"285",  league:"preset"},
    "ãƒ¡ã‚­ã‚·ã‚³":       {id:"128",  league:"preset"},
    "ã‚¯ãƒ­ã‚¢ãƒã‚¢":     {id:"219",  league:"preset"},
    "ã‚»ãƒã‚¬ãƒ«":       {id:"175",  league:"preset"},
    "ãƒ¢ãƒ­ãƒƒã‚³":       {id:"208",  league:"preset"},
    "ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢": {id:"283",  league:"preset"},
  }
};

// ============================================================
// STATE
// ============================================================
let currentFormation = "4-3-3";
let lineup = {}; // slotIndex -> player

// OPPONENT STATE
let opponentEnabled = false;
let activeTeam = 'home'; // 'home' | 'away'
let opponentFormation = '4-4-2';
let opponentLineup = {};
let opponentBench = [null, null, null, null, null];
let activeModalTeam = 'home';
let bench = [null, null, null, null, null]; // 5 bench slots
let teamPlayers = [];
let customPlayers = JSON.parse(localStorage.getItem('customPlayers') || '[]');
let allPlayers = []; // all available players across loaded teams (accumulates!)
let loadedTeamPlayers = {}; // teamName -> players (cache)
let pendingSearch = null; // {name, imgSrc}
let uploadImgDataUrl = null;
let activeModalMode = null; // 'slot' | 'bench'
let activeSlotIdx = null;
let activeBenchIdx = null;
let currentTeamId = null;
let playerSearchFilter = '';
let modalFilter = '';
let allModalPlayers = [];

// ============================================================
// ROLE MAPPING (for smart formation change)
// ============================================================
const ROLE_GROUP = {
  'GK':0,
  'CB':1,'DF':1,
  'RB':2,'RWB':2,
  'LB':3,'LWB':3,
  'DM':4,'CDM':4,
  'CM':5,
  'OM':6,'OMF':6,'AM':6,
  'RM':7,'RMF':7,'RW':7,
  'LM':8,'LMF':8,'LW':8,
  'SS':9,
  'CF':10,'ST':10,'FW':10
};
function getRoleGroup(role) {
  if (ROLE_GROUP[role] !== undefined) return ROLE_GROUP[role];
  if (/GK/.test(role)) return 0;
  if (/WB/.test(role)) return /^R/.test(role) ? 2 : 3;
  if (/^CB/.test(role)) return 1;
  if (/^DM/.test(role)) return 4;
  if (/^[RL]M$/.test(role)||/^[RL]W$/.test(role)) return /^R/.test(role) ? 7 : 8;
  if (/ST|CF|FW/.test(role)) return 10;
  return 5;
}
function smartRemapLineup(oldPositions, newPositions, oldLineup) {
  const available = Object.entries(oldLineup)
    .filter(([,p]) => p)
    .map(([idx, player]) => {
      const pos = oldPositions[+idx];
      return { player, group: getRoleGroup(pos.role), x: pos.x, y: pos.y, used: false };
    });
  const newLineup = {};
  newPositions.forEach((newPos, newIdx) => {
    const ng = getRoleGroup(newPos.role);
    let best = -1, bestScore = Infinity;
    available.forEach((a, i) => {
      if (a.used) return;
      const score = Math.abs(a.group - ng) * 40 + Math.abs(a.x - newPos.x) + Math.abs(a.y - newPos.y);
      if (score < bestScore) { bestScore = score; best = i; }
    });
    if (best >= 0) { newLineup[newIdx] = available[best].player; available[best].used = true; }
  });
  return newLineup;
}

// ============================================================
// INIT
// ============================================================
function init() {
  // Formations
  const fg = document.getElementById('formationGrid');
  Object.keys(FORMATIONS).forEach(f => {
    const btn = document.createElement('button');
    btn.className = 'formation-btn' + (f===currentFormation?' active':'');
    btn.textContent = f;
    btn.onclick = () => setFormation(f);
    fg.appendChild(btn);
  });

  // Leagues
  const ls = document.getElementById('leagueSelect');
  Object.keys(LEAGUES).forEach(league => {
    const o = document.createElement('option');
    o.value = league; o.textContent = league;
    ls.appendChild(o);
  });

  renderPitch();
  renderLineupList();
  renderCustomManageList();
  // Load from share URL if present
  loadFromHash();
  // Show QR button when served from a real URL
  if (window.location.protocol !== 'file:') {
    document.getElementById('qrBtn').style.display = '';
  }
  // Initialize pinch zoom for mobile
  initPitchZoom();
}

function setFormation(f) {
  if (activeTeam === 'away') {
    const oldPos = FORMATIONS[opponentFormation].positions;
    const newPos = FORMATIONS[f].positions;
    opponentLineup = smartRemapLineup(oldPos, newPos, opponentLineup);
    opponentFormation = f;
  } else {
    const oldPos = FORMATIONS[currentFormation].positions;
    const newPos = FORMATIONS[f].positions;
    lineup = smartRemapLineup(oldPos, newPos, lineup);
    currentFormation = f;
  }
  document.querySelectorAll('.formation-btn').forEach(b => b.classList.toggle('active', b.textContent===f));
  renderPitch();
  renderLineupList();
  updateLineupCount();
}

function loadLeague() {
  const league = document.getElementById('leagueSelect').value;
  const ts = document.getElementById('teamSelect');
  ts.innerHTML = '<option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>';
  if (!league) return;
  const teams = LEAGUES[league];
  Object.keys(teams).forEach(team => {
    const o = document.createElement('option');
    o.value = team;
    const info = teams[team];
    o.dataset.id = info.id;
    o.dataset.league = info.league;
    if (info.animeId) o.dataset.animeId = info.animeId;
    o.textContent = team;
    ts.appendChild(o);
  });
}

async function loadTeam() {
  const ts = document.getElementById('teamSelect');
  const selected = ts.options[ts.selectedIndex];
  const teamName = selected.value;
  const teamId = selected.dataset.id;
  const teamLeague = selected.dataset.league;
  const animeId = selected.dataset.animeId ? parseInt(selected.dataset.animeId) : null;
  if (!teamName) return;

  currentTeamId = teamId;
  // å·¦ãƒ‘ãƒãƒ«ã®ãƒãƒ¼ãƒ é¸æŠã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ã«ã‚‚åæ˜ ï¼ˆãƒãƒ¼ãƒ é¸æŠå¾Œã«ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚é¸æŠãƒãƒ¼ãƒ ãŒå¼•ãç¶™ãŒã‚Œã‚‹ï¼‰
  lastPickerLeague = document.getElementById('leagueSelect').value;
  lastPickerTeam = teamName;

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ãªã‚‰å³åæ˜ 
  if (loadedTeamPlayers[teamName]) {
    teamPlayers = loadedTeamPlayers[teamName];
    rebuildAllPlayers();
    renderPlayerList();
    setStatus(`âœ… ${teamPlayers.length}äºº (${teamName})`, false);
    return;
  }

  setStatus(`â³ ${teamName} ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...`, true);

  try {
    let players = [];

    if (teamLeague === 'preset') {
      // å›½ä»£è¡¨: ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ä½¿ç”¨
      players = loadPresetPlayers(teamName);
      if (!players.length) throw new Error('ãƒ—ãƒªã‚»ãƒƒãƒˆãªã—');
      loadedTeamPlayers[teamName] = players;
      teamPlayers = players;
      rebuildAllPlayers();
      renderPlayerList();
      setStatus(`âœ… ${players.length}äºº (${teamName}) â€” å†™çœŸå–å¾—ä¸­...`, false);
      enrichWithWikiPhotos(players).then(() => {
        syncPhotosToLineupAndBench(players);
        setStatus(`âœ… ${players.length}äºº (${teamName})`, false);
      });

    } else if (teamLeague === 'jpn.1') {
      // Jãƒªãƒ¼ã‚°: Wikipediaæ—¥æœ¬èªç‰ˆã‹ã‚‰å–å¾—
      players = await fetchWikiSquad(teamName);
      if (players.length < 3 && TEAM_PRESETS[teamName]) {
        players = loadPresetPlayers(teamName);
      }
      loadedTeamPlayers[teamName] = players;
      teamPlayers = players;
      rebuildAllPlayers();
      renderPlayerList();
      setStatus(`âœ… ${players.length}äºº (${teamName}) â€” å†™çœŸå–å¾—ä¸­...`, false);
      enrichWithWikiPhotos(players).then(() => {
        syncPhotosToLineupAndBench(players);
        setStatus(`âœ… ${players.length}äºº (${teamName})`, false);
      });

    } else {
      // ESPN: ãƒ—ãƒ¬ãƒŸã‚¢ãƒªãƒ¼ã‚°ç­‰
      players = await fetchESPNSquad(teamName, teamId, teamLeague);
      loadedTeamPlayers[teamName] = players;
      teamPlayers = players;
      rebuildAllPlayers();
      renderPlayerList();
      setStatus(`âœ… ${players.length}äººå–å¾—å®Œäº† â€” å†™çœŸå–å¾—ä¸­...`, false);
      enrichWithWikiPhotos(players).then(() => {
        syncPhotosToLineupAndBench(players);
        setStatus(`âœ… ${players.length}äºº (${teamName})`, false);
      });
    }

  } catch(e) {
    console.warn('loadTeam failed:', e.message);
    // ESPNãŒãƒ€ãƒ¡ãªã‚‰ãƒ—ãƒªã‚»ãƒƒãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (TEAM_PRESETS[teamName]) {
      const players = loadPresetPlayers(teamName);
      loadedTeamPlayers[teamName] = players;
      teamPlayers = players;
      rebuildAllPlayers();
      renderPlayerList();
      setStatus(`âœ… ${players.length}äºº (ãƒ—ãƒªã‚»ãƒƒãƒˆ)`, false);
      enrichWithWikiPhotos(players).then(() => syncPhotosToLineupAndBench(players));
    } else {
      setStatus(`âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•— â€” ã‚«ã‚¹ã‚¿ãƒ é¸æ‰‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„`, false);
    }
  }
}

// ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¸æ‰‹ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
function loadPresetPlayers(teamName) {
  const data = TEAM_PRESETS[teamName];
  if (!data) return [];
  return data.map(p => ({ ...p, img: null, source: 'preset' }));
}

// å…¨ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒãƒ¼ãƒ  + ã‚«ã‚¹ã‚¿ãƒ é¸æ‰‹ã§allPlayersã‚’å†æ§‹ç¯‰
function rebuildAllPlayers() {
  const seen = new Set();
  allPlayers = [];
  // ç¾åœ¨ã®ãƒãƒ¼ãƒ ã‚’å…ˆé ­ã«
  for (const p of (teamPlayers || [])) {
    if (!seen.has(p.name)) { seen.add(p.name); allPlayers.push(p); }
  }
  // éå»ã«ãƒ­ãƒ¼ãƒ‰ã—ãŸä»–ã®ãƒãƒ¼ãƒ ã®é¸æ‰‹ã‚‚è¿½åŠ 
  for (const [tname, players] of Object.entries(loadedTeamPlayers)) {
    if (players === teamPlayers) continue;
    for (const p of players) {
      if (!seen.has(p.name)) { seen.add(p.name); allPlayers.push(p); }
    }
  }
  // ã‚«ã‚¹ã‚¿ãƒ é¸æ‰‹
  for (const p of customPlayers) {
    if (!seen.has(p.name)) { seen.add(p.name); allPlayers.push(p); }
  }
}

// lineup/benchå†…ã®é¸æ‰‹ã®å†™çœŸã‚’æœ€æ–°ã«åŒæœŸ
function syncPhotosToLineupAndBench(players) {
  const photoMap = {};
  players.forEach(p => { if (p.img) photoMap[p.name] = p.img; });
  Object.values(lineup).forEach(p => { if (p && photoMap[p.name]) p.img = photoMap[p.name]; });
  bench.forEach(p => { if (p && photoMap[p.name]) p.img = photoMap[p.name]; });
  renderLineupList();
  renderPitch();
}

// Enrich players with Wikipedia photos progressively
async function enrichWithWikiPhotos(players) {
  let updateCount = 0;
  for (const player of players) {
    if (player.img) continue;
    try {
      const photo = await fetchWikiPhoto(player.name);
      if (photo) {
        player.img = photo;
        updateCount++;
        // Re-render every 3 photos for progressive display
        if (updateCount % 3 === 0) {
          renderPlayerList();
          renderLineupList(); // update lineup panel photos too
          renderPitch();      // update pitch player icons too
        }
      }
    } catch(e) {}
    await new Promise(r => setTimeout(r, 80));
  }
  if (updateCount > 0) {
    renderPlayerList();
    renderLineupList();
    renderPitch();
  }
}

function setStatus(msg, loading) {
  const el = document.getElementById('tmStatus');
  el.innerHTML = loading ? `<span class="spinner"></span> ${msg}` : msg;
}

// ============================================================
// FOOTBALL-DATA.ORG API (primary - official, free tier)
// + ESPN API (photo lookup by player name)
// ============================================================
const FD_API_KEY = "0c5feba391ee439a84d82e7a7c801405";

const FD_TEAM_MAP = {
  "ãƒãƒ³ãƒã‚§ã‚¹ã‚¿ãƒ¼C": {fdId:65, comp:"PL"},
  "ã‚¢ãƒ¼ã‚»ãƒŠãƒ«": {fdId:57, comp:"PL"},
  "ãƒªãƒ´ã‚¡ãƒ—ãƒ¼ãƒ«": {fdId:64, comp:"PL"},
  "ãƒã‚§ãƒ«ã‚·ãƒ¼": {fdId:61, comp:"PL"},
  "ãƒãƒ³ãƒã‚§ã‚¹ã‚¿ãƒ¼U": {fdId:66, comp:"PL"},
  "ãƒˆãƒƒãƒ†ãƒŠãƒ ": {fdId:73, comp:"PL"},
  "ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒƒã‚¹ãƒ«": {fdId:67, comp:"PL"},
  "ã‚¢ã‚¹ãƒˆãƒ³ãƒ»ãƒ´ã‚£ãƒ©": {fdId:58, comp:"PL"},
  "ã‚¦ã‚§ã‚¹ãƒˆãƒãƒ ": {fdId:563, comp:"PL"},
  "ãƒ–ãƒ©ã‚¤ãƒˆãƒ³": {fdId:397, comp:"PL"},
  "ãƒ•ãƒ©ãƒ ": {fdId:63, comp:"PL"},
  "ã‚¦ã‚©ãƒ«ãƒ´ã‚¡ãƒ¼ãƒãƒ³ãƒ—ãƒˆãƒ³": {fdId:76, comp:"PL"},
  "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ‘ãƒ¬ã‚¹": {fdId:354, comp:"PL"},
  "ãƒ–ãƒ¬ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ‰": {fdId:402, comp:"PL"},
  "ã‚¨ãƒ´ã‚¡ãƒ¼ãƒˆãƒ³": {fdId:62, comp:"PL"},
  "ãƒœãƒ¼ãƒ³ãƒã‚¹": {fdId:1044, comp:"PL"},
  "ãƒãƒƒãƒ†ã‚£ãƒ³ã‚¬ãƒ ãƒ»ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ": {fdId:351, comp:"PL"},
  "ã‚¤ãƒ—ã‚¹ã‚¦ã‚£ãƒƒãƒ": {fdId:57, comp:"PL"},
  "ãƒ¬ã‚¹ã‚¿ãƒ¼": {fdId:338, comp:"PL"},
  "ã‚µã‚¦ã‚µãƒ³ãƒ—ãƒˆãƒ³": {fdId:340, comp:"PL"},
  "ãƒãƒ«ã‚»ãƒ­ãƒŠ": {fdId:81, comp:"PD"},
  "ãƒ¬ã‚¢ãƒ«ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰": {fdId:86, comp:"PD"},
  "ã‚¢ãƒˆãƒ¬ãƒ†ã‚£ã‚³ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰": {fdId:78, comp:"PD"},
  "ã‚»ãƒ“ãƒ¼ã‚¸ãƒ£": {fdId:559, comp:"PD"},
  "ãƒ“ã‚¸ãƒ£ãƒ¬ã‚¢ãƒ«": {fdId:94, comp:"PD"},
  "ãƒ¬ã‚¢ãƒ«ãƒ»ã‚½ã‚·ã‚¨ãƒ€": {fdId:92, comp:"PD"},
  "ãƒ™ãƒ†ã‚£ã‚¹": {fdId:90, comp:"PD"},
  "ã‚¢ã‚¹ãƒ¬ãƒ†ã‚£ãƒƒã‚¯ãƒ»ã‚¯ãƒ«ãƒ–": {fdId:77, comp:"PD"},
  "ãƒãƒ¬ãƒ³ã‚·ã‚¢": {fdId:95, comp:"PD"},
  "ã‚¸ãƒ­ãƒ¼ãƒŠ": {fdId:298, comp:"PD"},
  "ãƒã‚¸ãƒ§ãƒ«ã‚«": {fdId:89, comp:"PD"},
  "ã‚¢ãƒ©ãƒ™ã‚¹": {fdId:263, comp:"PD"},
  "ã‚²ã‚¿ãƒ•ã‚§": {fdId:79, comp:"PD"},
  "ãƒ©ãƒ¼ã‚¸ãƒ§": {fdId:87, comp:"PD"},
  "ã‚»ãƒ«ã‚¿": {fdId:558, comp:"PD"},
  "ã‚ªã‚µã‚¹ãƒŠ": {fdId:80, comp:"PD"},
  "ãƒ©ã‚¹ãƒ»ãƒ‘ãƒ«ãƒã‚¹": {fdId:275, comp:"PD"},
  "ã‚¨ã‚¹ãƒ‘ãƒ‹ãƒ§ãƒ¼ãƒ«": {fdId:83, comp:"PD"},
  "ãƒ¬ã‚¬ãƒã‚¹": {fdId:745, comp:"PD"},
  "ãƒã‚¸ãƒ£ãƒ‰ãƒªãƒ¼ãƒ‰": {fdId:250, comp:"PD"},
  "ãƒã‚¤ã‚¨ãƒ«ãƒ³ãƒ»ãƒŸãƒ¥ãƒ³ãƒ˜ãƒ³": {fdId:5, comp:"BL1"},
  "ãƒœãƒ«ã‚·ã‚¢ãƒ»ãƒ‰ãƒ«ãƒˆãƒ ãƒ³ãƒˆ": {fdId:4, comp:"BL1"},
  "RBãƒ©ã‚¤ãƒ—ãƒ„ã‚£ãƒ’": {fdId:721, comp:"BL1"},
  "ãƒ¬ãƒãƒ¼ã‚¯ãƒ¼ã‚¼ãƒ³": {fdId:3, comp:"BL1"},
  "ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ": {fdId:19, comp:"BL1"},
  "ã‚·ãƒ¥ãƒˆã‚¥ãƒƒãƒˆã‚¬ãƒ«ãƒˆ": {fdId:10, comp:"BL1"},
  "ãƒ´ã‚©ãƒ«ãƒ•ã‚¹ãƒ–ãƒ«ã‚¯": {fdId:11, comp:"BL1"},
  "ãƒ›ãƒƒãƒ•ã‚§ãƒ³ãƒã‚¤ãƒ ": {fdId:1275, comp:"BL1"},
  "ãƒ•ãƒ©ã‚¤ãƒ–ãƒ«ã‚¯": {fdId:17, comp:"BL1"},
  "ã‚¢ã‚¦ã‚¯ã‚¹ãƒ–ãƒ«ã‚¯": {fdId:16, comp:"BL1"},
  "ãƒœãƒ¼ãƒ•ãƒ ": {fdId:36, comp:"BL1"},
  "ã‚¦ãƒ‹ã‚ªãƒ³ãƒ»ãƒ™ãƒ«ãƒªãƒ³": {fdId:28, comp:"BL1"},
  "ãƒã‚¤ãƒ³ãƒ„": {fdId:15, comp:"BL1"},
  "ãƒ´ã‚§ãƒ«ãƒ€ãƒ¼ãƒ»ãƒ–ãƒ¬ãƒ¼ãƒ¡ãƒ³": {fdId:12, comp:"BL1"},
  "ã‚°ãƒ©ãƒ¼ãƒ‰ãƒãƒƒãƒ": {fdId:18, comp:"BL1"},
  "ãƒã‚¤ãƒ‡ãƒ³ãƒã‚¤ãƒ ": {fdId:123, comp:"BL1"},
  "ã‚¶ãƒ³ã‚¯ãƒˆãƒ»ãƒ‘ã‚¦ãƒª": {fdId:29, comp:"BL1"},
  "ã‚±ãƒ«ãƒ³": {fdId:1, comp:"BL1"},
  "ã‚¤ãƒ³ãƒ†ãƒ«": {fdId:108, comp:"SA"},
  "ãƒŸãƒ©ãƒ³": {fdId:98, comp:"SA"},
  "ãƒ¦ãƒ´ã‚§ãƒ³ãƒˆã‚¹": {fdId:109, comp:"SA"},
  "ãƒŠãƒãƒª": {fdId:113, comp:"SA"},
  "ãƒ­ãƒ¼ãƒ": {fdId:100, comp:"SA"},
  "ãƒ©ãƒ„ã‚£ã‚ª": {fdId:110, comp:"SA"},
  "ã‚¢ã‚¿ãƒ©ãƒ³ã‚¿": {fdId:102, comp:"SA"},
  "ãƒ•ã‚£ã‚ªãƒ¬ãƒ³ãƒ†ã‚£ãƒ¼ãƒŠ": {fdId:99, comp:"SA"},
  "ãƒœãƒ­ãƒ¼ãƒ‹ãƒ£": {fdId:103, comp:"SA"},
  "ãƒˆãƒªãƒ": {fdId:586, comp:"SA"},
  "ãƒ¢ãƒ³ãƒ„ã‚¡": {fdId:674, comp:"SA"},
  "ã‚¨ãƒ³ãƒãƒª": {fdId:445, comp:"SA"},
  "ã‚¦ãƒ‡ã‚£ãƒãƒ¼ã‚¼": {fdId:115, comp:"SA"},
  "ã‚¸ã‚§ãƒã‚¢": {fdId:107, comp:"SA"},
  "ãƒ´ã‚§ãƒ­ãƒ¼ãƒŠ": {fdId:450, comp:"SA"},
  "ãƒ¬ãƒƒãƒã‚§": {fdId:454, comp:"SA"},
  "ãƒ‘ãƒªSG": {fdId:524, comp:"FL1"},
  "ãƒ¢ãƒŠã‚³": {fdId:548, comp:"FL1"},
  "ãƒãƒ«ã‚»ã‚¤ãƒ¦": {fdId:516, comp:"FL1"},
  "ãƒªãƒ¨ãƒ³": {fdId:523, comp:"FL1"},
  "ãƒªãƒ¼ãƒ«": {fdId:521, comp:"FL1"},
  "ãƒ¬ãƒ³ãƒŒ": {fdId:511, comp:"FL1"},
  "ãƒ‹ãƒ¼ã‚¹": {fdId:522, comp:"FL1"},
  "ã‚¹ãƒˆãƒ©ã‚¹ãƒ–ãƒ¼ãƒ«": {fdId:576, comp:"FL1"},
  "ãƒ©ãƒ³ã‚¹": {fdId:532, comp:"FL1"},
  "ãƒŠãƒ³ãƒˆ": {fdId:543, comp:"FL1"},
  "ãƒ–ãƒ¬ã‚¹ãƒˆ": {fdId:512, comp:"FL1"},
  "ãƒˆã‚¥ãƒ¼ãƒ«ãƒ¼ã‚º": {fdId:513, comp:"FL1"},
  "ãƒ«ãƒ»ã‚¢ãƒ¼ãƒ–ãƒ«": {fdId:531, comp:"FL1"},
  "ã‚µãƒ³=ãƒ†ãƒ†ã‚£ã‚¨ãƒ³ãƒŒ": {fdId:527, comp:"FL1"},
  "ãƒ¢ãƒ³ãƒšãƒªã‚¨": {fdId:514, comp:"FL1"},
  "ã‚¢ãƒ³ã‚¸ã‚§": {fdId:515, comp:"FL1"},
};

// Map football-data.org position strings to GK/DF/MF/FW
function mapFDPosition(pos) {
  if (!pos) return 'MF';
  if (pos === 'Goalkeeper') return 'GK';
  if (pos === 'Defence') return 'DF';
  if (pos === 'Midfield') return 'MF';
  if (pos === 'Offence' || pos === 'Forward') return 'FW';
  return 'MF';
}

// Wikipedia photo lookup - reliable for top soccer players worldwide
// Uses Wikipedia's API to find the player's page image
const wikiPhotoCache = {};

async function fetchWikiPhoto(playerName) {
  if (wikiPhotoCache[playerName] !== undefined) return wikiPhotoCache[playerName];
  
  const queries = [
    `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(playerName)}&prop=pageimages&format=json&pithumbsize=300&origin=*`,
    `https://ja.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(playerName)}&prop=pageimages&format=json&pithumbsize=300&origin=*`
  ];
  
  for (const url of queries) {
    try {
      const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
      if (!res.ok) continue;
      const data = await res.json();
      const pages = Object.values(data?.query?.pages || {});
      const thumb = pages[0]?.thumbnail?.source;
      if (thumb) {
        const hiRes = thumb.replace(/\/\d+px-/, '/300px-');
        // Convert to base64 immediately so html2canvas can render it
        const b64 = await urlToBase64(hiRes);
        const result = b64 || hiRes; // fallback to URL if conversion fails
        wikiPhotoCache[playerName] = result;
        return result;
      }
    } catch(e) {}
  }
  
  wikiPhotoCache[playerName] = null;
  return null;
}

// Convert any image URL to base64 data URL
// Works for CORS-enabled sources (Wikipedia, etc.)
async function urlToBase64(url) {
  try {
    const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
    if (!res.ok) return null;
    const blob = await res.blob();
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = () => resolve(null);
      reader.readAsDataURL(blob);
    });
  } catch(e) { return null; }
}

// Fetch squad from football-data.org
// Free tier: no rate limit header needed for basic use (10 req/min)
async function fetchFDSquad(teamName) {
  const teamInfo = FD_TEAM_MAP[teamName];
  if (!teamInfo) throw new Error(`No FD mapping for: ${teamName}`);
  
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 12000);
  
  try {
    const res = await fetch(
      `https://api.football-data.org/v4/teams/${teamInfo.fdId}/`,
      {
        signal: controller.signal,
        headers: {
          'X-Auth-Token': FD_API_KEY
        }
      }
    );
    clearTimeout(timeout);
    if (!res.ok) throw new Error(`FD API: HTTP ${res.status}`);
    const data = await res.json();
    
    // Response shape: { squad: [{ id, name, position, shirtNumber, nationality }] }
    const squad = data.squad || [];
    
    const players = squad.map(p => {
      const pos = mapFDPosition(p.position);
      const num = parseInt(p.shirtNumber) || 0;
      return { name: p.name, pos, num, img: null, fdId: p.id, fdComp: teamInfo.comp, source: 'fd' };
    }).filter(p => p.name);

    return players;
  } catch(e) {
    clearTimeout(timeout);
    throw e;
  }
}

// Fetch ESPN squad as fallback (for J1 and teams not in FD)
function mapESPNPosition(posAbbr) {
  if (!posAbbr) return 'MF';
  const p = posAbbr.toUpperCase();
  if (p === 'GK' || p === 'G') return 'GK';
  if (['CB','LB','RB','LWB','RWB','D','SW','DF'].includes(p)) return 'DF';
  if (['CM','CAM','CDM','LM','RM','DM','M','MF','AM'].includes(p)) return 'MF';
  if (['ST','CF','LW','RW','SS','F','FW','W'].includes(p)) return 'FW';
  return 'MF';
}

// ============================================================
// Wikipediaæ—¥æœ¬èªç‰ˆã‹ã‚‰Jãƒªãƒ¼ã‚°ãƒãƒ¼ãƒ ã®é¸æ‰‹ãƒªã‚¹ãƒˆã‚’å–å¾—
// ============================================================
async function fetchWikiSquad(teamName) {
  // Wikipedia APIã§ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’æ¤œç´¢ â†’ é¸æ‰‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ¼ã‚¹
  try {
    // ã¾ãšãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’æ¤œç´¢
    const searchUrl = `https://ja.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(teamName + ' ã‚µãƒƒã‚«ãƒ¼ é¸æ‰‹')}&format=json&origin=*&srlimit=3`;
    const searchRes = await fetch(searchUrl, { signal: AbortSignal.timeout(8000) });
    if (!searchRes.ok) throw new Error('Wiki search failed');
    const searchData = await searchRes.json();
    
    const hits = searchData.query?.search || [];
    if (!hits.length) throw new Error('No wiki page found');
    
    // ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¢ã™ï¼ˆ"FC" ã‚„ "ãƒ¬ãƒƒã‚º" ç­‰ã‚’å«ã‚€ï¼‰
    const pageTitle = hits[0].title;
    
    // ãƒšãƒ¼ã‚¸ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼å†…ã®é¸æ‰‹ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ï¼‰
    const catUrl = `https://ja.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=Category:${encodeURIComponent(teamName + 'ã®é¸æ‰‹')}&format=json&origin=*&cmlimit=50&cmtype=page`;
    const catRes = await fetch(catUrl, { signal: AbortSignal.timeout(8000) });
    if (!catRes.ok) throw new Error('Wiki category failed');
    const catData = await catRes.json();
    
    const members = catData.query?.categorymembers || [];
    if (members.length < 3) throw new Error('Too few category members');
    
    // é¸æ‰‹ãƒšãƒ¼ã‚¸ã‹ã‚‰åå‰ã¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    const players = members.slice(0, 40).map((m, i) => {
      // ã‚«ãƒ†ã‚´ãƒªåã‹ã‚‰åå‰ã‚’å–å¾—
      const name = m.title.replace(/\s*\(.*\)/, '').trim();
      return { name, pos: 'MF', num: 0, img: null, source: 'wiki', wikiTitle: m.title };
    }).filter(p => p.name);
    
    return players;
  } catch(e) {
    console.warn('fetchWikiSquad failed:', e.message);
    throw e;
  }
}


async function fetchESPNSquad(teamName, teamId, league) {
  const url = `https://site.api.espn.com/apis/site/v2/sports/soccer/${league}/teams/${teamId}/roster`;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 12000);
  try {
    const res = await fetch(url, { signal: controller.signal });
    clearTimeout(timeout);
    if (!res.ok) throw new Error(`ESPN HTTP ${res.status}`);
    const data = await res.json();
    let athleteList = [];
    if (Array.isArray(data.athletes)) athleteList = data.athletes;
    else if (data.athletes) Object.values(data.athletes).forEach(g => {
      if (Array.isArray(g)) athleteList.push(...g);
      else if (g.items) athleteList.push(...g.items);
    });
    const players = athleteList.map(a => {
      const athlete = a.athlete || a;
      const espnId = athlete.id || a.id;
      const name = athlete.displayName || athlete.fullName || '';
      const pos = mapESPNPosition(athlete.position?.abbreviation || a.position?.abbreviation);
      const num = parseInt(athlete.jersey || a.jersey) || 0;
      // Check if headshot URL is provided directly in response (more reliable)
      const headshotHref = athlete.headshot?.href || a.headshot?.href || null;
      // Only use ESPN CDN if headshot href is provided directly; otherwise use wiki
      const img = headshotHref || null;
      return { name, pos, num, img, espnId, source: 'espn' };
    }).filter(p => p.name);
    if (players.length < 3) throw new Error('Too few players');
    return players;
  } catch(e) { clearTimeout(timeout); throw e; }
}


// ============================================================
// PRESET PLAYER DATA (with Transfermarkt image URLs)
// Images: ESPN CDN (https://a.espncdn.com/i/headshots/soccer/players/full/{id}.png)
// ============================================================
// PASTE INTO CODE:
const TEAM_PRESETS = {
  "ãƒãƒ«ã‚»ãƒ­ãƒŠ": [
    {name:"ãƒ†ã‚¢ãƒ»ã‚·ãƒ¥ãƒ†ãƒ¼ã‚²ãƒ³",num:1,pos:"GK"},
    {name:"ã‚¤ãƒ‹ãƒ£ã‚­ãƒ»ãƒšãƒ¼ãƒ‹ãƒ£",num:13,pos:"GK"},
    {name:"ãƒ‘ã‚¦ãƒ»ã‚¯ãƒãƒ«ã‚·",num:2,pos:"DF"},
    {name:"ãƒ­ãƒŠãƒ«ãƒ‰ãƒ»ã‚¢ãƒ©ã‚¦ãƒ›",num:4,pos:"DF"},
    {name:"ã‚¢ãƒ³ãƒ‰ãƒ¬ã‚¢ã‚¹ãƒ»ã‚¯ãƒªã‚¹ãƒ†ãƒ³ã‚»ãƒ³",num:15,pos:"DF"},
    {name:"ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ã‚¯ãƒ³ãƒ‡",num:23,pos:"DF"},
    {name:"ã‚¨ãƒªãƒƒã‚¯ãƒ»ã‚¬ãƒ«ã‚·ã‚¢",num:24,pos:"DF"},
    {name:"ã‚¢ãƒ¬ãƒãƒ³ãƒ‰ãƒ­ãƒ»ãƒãƒ«ãƒ‡",num:3,pos:"DF"},
    {name:"ãƒšãƒ‰ãƒª",num:8,pos:"MF"},
    {name:"ãƒ•ãƒ¬ãƒ³ã‚­ãƒ¼ãƒ»ãƒ‡ãƒ»ãƒ¨ãƒ³ã‚°",num:21,pos:"MF"},
    {name:"ã‚¬ãƒ“",num:6,pos:"MF"},
    {name:"ãƒãƒ«ã‚¯ãƒ»ã‚«ã‚µãƒ‰",num:14,pos:"MF"},
    {name:"ãƒ€ãƒ‹ãƒ»ã‚ªãƒ«ãƒ¢",num:20,pos:"MF"},
    {name:"ãƒãƒ«ã‚³ã‚¹ãƒ»ã‚¢ãƒ­ãƒ³ã‚½",num:17,pos:"MF"},
    {name:"ãƒ©ãƒŸãƒ³ãƒ»ãƒ¤ãƒãƒ«",num:19,pos:"FW"},
    {name:"ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‹ãƒ£",num:11,pos:"FW"},
    {name:"ãƒ­ãƒ™ãƒ«ãƒˆãƒ»ãƒ¬ãƒãƒ³ãƒ‰ãƒ•ã‚¹ã‚­",num:9,pos:"FW"},
    {name:"ã‚¢ãƒ³ã‚¹ãƒ»ãƒ•ã‚¡ãƒ†ã‚£",num:10,pos:"FW"},
    {name:"ãƒ•ã‚§ãƒ©ãƒ³ãƒ»ãƒˆãƒ¼ãƒ¬ã‚¹",num:7,pos:"FW"},
    {name:"ãƒ‘ã‚¦ãƒ»ãƒ“ã‚¯ãƒˆãƒ«",num:12,pos:"FW"},
  ],
  "ãƒ¬ã‚¢ãƒ«ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰": [
    {name:"ãƒ«ãƒ‹ãƒ³",num:25,pos:"GK"},
    {name:"ã‚¯ãƒ«ãƒˆãƒ¯",num:1,pos:"GK"},
    {name:"ã‚«ãƒ«ãƒãƒãƒ«",num:2,pos:"DF"},
    {name:"ãƒŸãƒªãƒˆãƒ³",num:3,pos:"DF"},
    {name:"ã‚¢ãƒ©ãƒ",num:4,pos:"DF"},
    {name:"ãƒªãƒ¥ãƒ‡ã‚£ã‚¬ãƒ¼",num:22,pos:"DF"},
    {name:"ã‚¬ãƒ«ã‚·ã‚¢ãƒ»ãƒ•ãƒ©ãƒ³",num:23,pos:"DF"},
    {name:"ãƒ•ã‚§ãƒ«ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ¡ãƒ³ãƒ‡ã‚£",num:23,pos:"DF"},
    {name:"ãƒãƒ¥ã‚¢ãƒ¡ãƒ‹",num:14,pos:"MF"},
    {name:"ãƒãƒ«ãƒ™ãƒ«ãƒ‡",num:15,pos:"MF"},
    {name:"ãƒ¢ãƒ‰ãƒªãƒƒãƒ",num:10,pos:"MF"},
    {name:"ã‚¯ãƒ­ãƒ¼ã‚¹",num:8,pos:"MF"},
    {name:"ãƒ™ãƒªãƒ³ã‚¬ãƒ ",num:5,pos:"MF"},
    {name:"ã‚«ãƒãƒ´ã‚£ãƒ³ã‚¬",num:12,pos:"MF"},
    {name:"ãƒ“ãƒ‹ã‚·ã‚¦ã‚¹",num:7,pos:"FW"},
    {name:"ãƒ­ãƒ‰ãƒªã‚´",num:11,pos:"FW"},
    {name:"ãƒ ãƒãƒƒãƒš",num:9,pos:"FW"},
    {name:"ãƒ–ãƒ©ãƒ’ãƒ ãƒ»ãƒ‡ã‚£ã‚¢ã‚¹",num:21,pos:"FW"},
    {name:"ãƒ›ã‚»ãƒ«",num:18,pos:"FW"},
  ],
  "ã‚¢ãƒˆãƒ¬ãƒ†ã‚£ã‚³ãƒ»ãƒãƒ‰ãƒªãƒ¼ãƒ‰": [
    {name:"ã‚ªãƒ–ãƒ©ã‚¯",num:13,pos:"GK"},
    {name:"ãƒ’ãƒ¡ãƒã‚¹",num:2,pos:"DF"},
    {name:"ãƒ´ã‚£ãƒ„ã‚§ãƒ«",num:23,pos:"MF"},
    {name:"ãƒ¢ãƒªãƒ¼ãƒŠ",num:16,pos:"DF"},
    {name:"ãƒ˜ãƒ«ãƒ¢ã‚½",num:22,pos:"DF"},
    {name:"ãƒ‡ãƒ‘ã‚¦ãƒ«",num:6,pos:"MF"},
    {name:"ã‚³ã‚±",num:14,pos:"MF"},
    {name:"ãƒ¬ãƒãƒ«",num:8,pos:"MF"},
    {name:"ã‚µã‚¦ãƒ¼ãƒ«",num:8,pos:"MF"},
    {name:"ã‚°ãƒªãƒ¼ã‚ºãƒãƒ³",num:7,pos:"FW"},
    {name:"ãƒ¢ãƒ©ã‚¿",num:19,pos:"FW"},
    {name:"ã‚³ãƒ¬ã‚¢",num:10,pos:"FW"},
    {name:"ãƒ¡ãƒ¡ãƒƒãƒˆãƒ»ãƒã‚§ãƒªã‚¯",num:4,pos:"DF"},
    {name:"ã‚¢ã‚¸ãƒ¥ãƒ³ãƒ»ãƒŠã‚¦ã‚¨ãƒ«",num:11,pos:"FW"},
    {name:"ã‚¸ãƒ¥ãƒªã‚¢ãƒ³ãƒ»ã‚¢ãƒ«ãƒãƒ¬ã‚¹",num:9,pos:"FW"},
  ],
  "ãƒãƒ³ãƒã‚§ã‚¹ã‚¿ãƒ¼C": [
    {name:"ã‚¨ãƒ‡ãƒ«ã‚½ãƒ³",num:31,pos:"GK"},
    {name:"ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼",num:2,pos:"DF"},
    {name:"ãƒãƒŒã‚¨ãƒ«ãƒ»ã‚¢ã‚«ãƒ³ã‚¸",num:25,pos:"DF"},
    {name:"ãƒ«ãƒ™ãƒ³ãƒ»ãƒ‡ã‚£ã‚¢ã‚¹",num:3,pos:"DF"},
    {name:"ã‚°ãƒãƒ«ãƒ‡ã‚£ã‚ªãƒ«",num:24,pos:"DF"},
    {name:"ã‚¸ãƒ§ãƒ³ãƒ»ã‚¹ãƒˆãƒ¼ãƒ³ã‚º",num:5,pos:"DF"},
    {name:"ãƒ­ãƒ‰ãƒª",num:16,pos:"MF"},
    {name:"ãƒ™ãƒ«ãƒŠãƒ«ãƒ‰ãƒ»ã‚·ãƒ«ãƒ",num:20,pos:"MF"},
    {name:"ãƒ‡ãƒ»ãƒ–ãƒ©ã‚¤ãƒ",num:17,pos:"MF"},
    {name:"ã‚³ãƒãƒãƒƒãƒ",num:8,pos:"MF"},
    {name:"ãƒ•ã‚©ãƒ¼ãƒ‡ãƒ³",num:47,pos:"MF"},
    {name:"ãƒ‰ã‚¯ãƒ¼",num:11,pos:"FW"},
    {name:"ãƒãƒ¼ãƒ©ãƒ³ãƒ‰",num:9,pos:"FW"},
    {name:"ã‚¸ãƒ£ãƒƒã‚¯ãƒ»ã‚°ãƒªãƒ¼ãƒªãƒƒã‚·ãƒ¥",num:10,pos:"FW"},
    {name:"ã‚µãƒ´ã‚£ãƒ¼ãƒ‹ãƒ§",num:26,pos:"FW"},
  ],
  "ã‚¢ãƒ¼ã‚»ãƒŠãƒ«": [
    {name:"ãƒ©ãƒ¤",num:22,pos:"GK"},
    {name:"ãƒ™ãƒ³ãƒ»ãƒ›ãƒ¯ã‚¤ãƒˆ",num:4,pos:"DF"},
    {name:"ã‚µãƒªãƒ",num:12,pos:"DF"},
    {name:"ãƒã‚¬ãƒªãƒ£ãƒ³ã‚¤ã‚¹",num:6,pos:"DF"},
    {name:"ã‚¸ãƒ³ãƒã‚§ãƒ³ã‚³",num:35,pos:"DF"},
    {name:"ã‚ªãƒ‡ã‚¬ãƒ¼ãƒ«",num:8,pos:"MF"},
    {name:"ãƒˆãƒ¼ãƒã‚¹ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£",num:5,pos:"MF"},
    {name:"ãƒãƒ«ãƒ†ã‚£ãƒãƒƒãƒª",num:11,pos:"FW"},
    {name:"ã‚µã‚«",num:7,pos:"FW"},
    {name:"ãƒãƒ´ã‚¡ãƒ¼ãƒ„",num:29,pos:"MF"},
    {name:"ãƒ¬ã‚¤ã‚¹ãƒ»ãƒãƒ«ã‚½ãƒ³",num:24,pos:"FW"},
    {name:"ãƒ˜ã‚¤ãƒ³ã‚º",num:14,pos:"DF"},
    {name:"ãƒã‚¦ã‚¹ãƒ–ãƒªã‚¹",num:2,pos:"DF"},
    {name:"ã‚¸ã‚§ã‚ºãƒ¼ã‚¹",num:9,pos:"FW"},
    {name:"ãƒ†ã‚£ãƒ³ãƒãƒ¼",num:32,pos:"DF"},
  ],
  "ãƒªãƒ´ã‚¡ãƒ—ãƒ¼ãƒ«": [
    {name:"ã‚¢ãƒªã‚½ãƒ³",num:1,pos:"GK"},
    {name:"ã‚¢ãƒ¬ã‚¯ã‚µãƒ³ãƒ€ãƒ¼=ã‚¢ãƒ¼ãƒãƒ«ãƒ‰",num:66,pos:"DF"},
    {name:"ãƒ•ã‚¡ãƒ³ãƒ»ãƒ€ã‚¤ã‚¯",num:4,pos:"DF"},
    {name:"ã‚³ãƒŠãƒ¼ãƒ†",num:5,pos:"DF"},
    {name:"ãƒ­ãƒãƒ¼ãƒˆã‚½ãƒ³",num:26,pos:"DF"},
    {name:"ãƒãƒƒã‚¯ãƒ»ã‚¢ãƒªã‚¹ã‚¿ãƒ¼",num:10,pos:"MF"},
    {name:"ã‚¬ã‚¯ãƒ",num:18,pos:"FW"},
    {name:"ã‚½ãƒœã‚¹ãƒ©ã‚¤",num:8,pos:"MF"},
    {name:"ã‚¨ãƒªã‚ªãƒƒãƒˆ",num:19,pos:"MF"},
    {name:"ã‚µãƒ©ãƒ¼",num:11,pos:"FW"},
    {name:"ãƒ‡ã‚£ã‚ªã‚´ãƒ»ã‚¸ãƒ§ã‚¿",num:20,pos:"FW"},
    {name:"ãƒŒãƒ‹ã‚§ã‚¹",num:9,pos:"FW"},
    {name:"ãƒ«ã‚¤ã‚¹ãƒ»ãƒ‡ã‚£ã‚¢ã‚¹",num:7,pos:"FW"},
    {name:"ã‚°ãƒ©ãƒ´ã‚§ãƒ³ãƒ™ãƒ«ãƒ•",num:38,pos:"MF"},
    {name:"ã‚¯ã‚¢ãƒ³ã‚µãƒ¼",num:2,pos:"DF"},
  ],
  "ãƒã‚§ãƒ«ã‚·ãƒ¼": [
    {name:"ã‚µãƒ³ãƒã‚§ã‚¹",num:1,pos:"GK"},
    {name:"ãƒªãƒ¼ã‚¹ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚º",num:24,pos:"DF"},
    {name:"ãƒã‚¢ã‚´ãƒ»ã‚·ã‚¦ãƒ",num:6,pos:"DF"},
    {name:"ã‚³ãƒ«ã‚¦ã‚£ãƒ«",num:26,pos:"DF"},
    {name:"ãƒ™ãƒ³ãƒ»ãƒãƒ«ã‚¦ã‚§ãƒ«",num:21,pos:"DF"},
    {name:"ã‚¨ãƒ³ã‚½ãƒ»ãƒ•ã‚§ãƒ«ãƒŠãƒ³ãƒ‡ã‚¹",num:8,pos:"MF"},
    {name:"ã‚³ãƒŠãƒ¼ãƒ»ã‚®ãƒ£ãƒ©ã‚¬ãƒ¼",num:23,pos:"MF"},
    {name:"ãƒ¢ã‚¤ã‚»ã‚¹ãƒ»ã‚«ã‚¤ã‚»ãƒ‰",num:25,pos:"MF"},
    {name:"ã‚³ãƒ¼ãƒ«ãƒ»ãƒ‘ãƒ¼ãƒãƒ¼",num:20,pos:"MF"},
    {name:"ãƒ‹ã‚³ãƒ©ã‚¹ãƒ»ã‚¸ãƒ£ã‚¯ã‚½ãƒ³",num:15,pos:"FW"},
    {name:"ã‚¹ã‚¿ãƒ¼ãƒªãƒ³ã‚°",num:7,pos:"FW"},
    {name:"ãƒ ãƒ‰ãƒªã‚¯",num:10,pos:"FW"},
    {name:"ãƒšãƒ‰ãƒ­ãƒ»ãƒãƒˆ",num:14,pos:"FW"},
    {name:"ã‚¸ãƒ£ã‚¯ã‚½ãƒ³",num:15,pos:"FW"},
    {name:"ã‚µãƒ³ãƒãƒ§",num:19,pos:"FW"},
  ],
  "ãƒã‚¤ã‚¨ãƒ«ãƒ³ãƒ»ãƒŸãƒ¥ãƒ³ãƒ˜ãƒ³": [
    {name:"ãƒã‚¤ã‚¢ãƒ¼",num:1,pos:"GK"},
    {name:"ã‚¦ãƒ«ãƒ©ã‚¤ãƒ’",num:26,pos:"GK"},
    {name:"ã‚³ãƒ³ãƒ‘ãƒ‹ãƒ¼ç›£ç£",num:0,pos:"DF"},
    {name:"ã‚­ãƒ ãƒ»ãƒŸãƒ³ã‚¸ã‚§",num:3,pos:"DF"},
    {name:"ãƒ€ãƒ¨ãƒ»ã‚¦ãƒ‘ãƒ¡ã‚«ãƒ",num:2,pos:"DF"},
    {name:"ã‚¢ãƒ«ãƒ•ã‚©ãƒ³ã‚½ãƒ»ãƒ‡ã‚¤ãƒ“ã‚¹",num:19,pos:"DF"},
    {name:"ãƒã‚¦ã‚·ãƒ«",num:12,pos:"DF"},
    {name:"ã‚³ãƒŠãƒ³ãƒ»ãƒãƒ¥ãƒ",num:0,pos:"DF"},
    {name:"ãƒ¬ã‚ªãƒ³ãƒ»ã‚´ãƒ¬ãƒ„ã‚«",num:8,pos:"MF"},
    {name:"ã‚¸ãƒ£ãƒãƒ«ãƒ»ãƒ ã‚·ã‚¢ãƒ©",num:42,pos:"MF"},
    {name:"ãƒˆãƒ¼ãƒã‚¹ãƒ»ãƒŸãƒ¥ãƒ©ãƒ¼",num:25,pos:"FW"},
    {name:"ãƒãƒªãƒ¼ãƒ»ã‚±ã‚¤ãƒ³",num:9,pos:"FW"},
    {name:"ã‚³ãƒ³ãƒ‘ãƒ‹ãƒ¼",num:38,pos:"DF"},
    {name:"ã‚µãƒ",num:10,pos:"FW"},
    {name:"ãƒ‹ãƒ£ãƒ–ãƒª",num:7,pos:"FW"},
    {name:"ã‚³ãƒŸãƒ³",num:5,pos:"DF"},
    {name:"ã‚­ãƒ³ã‚°ã‚¹ãƒ¬ãƒ¼ãƒ»ã‚³ãƒãƒ³",num:11,pos:"FW"},
    {name:"ãƒã‚ºãƒ©ã‚¦ã‚£",num:40,pos:"DF"},
  ],
  "ãƒœãƒ«ã‚·ã‚¢ãƒ»ãƒ‰ãƒ«ãƒˆãƒ ãƒ³ãƒˆ": [
    {name:"ã‚³ãƒ™ãƒ«",num:1,pos:"GK"},
    {name:"ãƒªã‚¨ãƒ«ã‚½ãƒ³",num:2,pos:"DF"},
    {name:"ãƒ•ãƒ³ãƒ¡ãƒ«ã‚¹",num:15,pos:"DF"},
    {name:"ã‚·ãƒ¥ãƒ­ãƒƒã‚¿ãƒ¼ãƒ“ãƒ¼ã‚¯",num:4,pos:"DF"},
    {name:"ãƒ©ã‚¤ãƒŠãƒ¼",num:30,pos:"DF"},
    {name:"ãƒ‹ã‚³ãƒ»ã‚·ãƒ¥ãƒ«ãƒ„",num:14,pos:"DF"},
    {name:"ã‚«ãƒ³",num:8,pos:"MF"},
    {name:"ã‚¸ãƒ¥ãƒ¼ãƒ‰ãƒ»ãƒ™ãƒªãƒ³ã‚¬ãƒ ",num:22,pos:"MF"},
    {name:"ãƒ ãƒ•ã‚¿ãƒ«",num:9,pos:"MF"},
    {name:"ãƒ­ã‚¤ã‚¹",num:11,pos:"FW"},
    {name:"ã‚¢ãƒ‡ã‚¤ã‚§ãƒŸ",num:27,pos:"FW"},
    {name:"ãƒ–ãƒ©ãƒ³ãƒˆ",num:10,pos:"MF"},
    {name:"ãƒãƒ¼ãƒ¬ãƒ³",num:25,pos:"FW"},
    {name:"ãƒ‹ã‚¯ãƒ©ã‚¹ãƒ»ãƒ•ãƒ¥ãƒ«ã‚¯ãƒ«ãƒ¼ã‚¯",num:9,pos:"FW"},
  ],
  "ã‚¤ãƒ³ãƒ†ãƒ«": [
    {name:"ã‚¾ãƒãƒ¼",num:1,pos:"GK"},
    {name:"ãƒ‘ãƒ´ã‚¡ãƒ¼ãƒ«",num:28,pos:"DF"},
    {name:"ãƒ‡ãƒ»ãƒ•ãƒ©ã‚¤",num:6,pos:"DF"},
    {name:"ãƒã‚¹ãƒˆãƒ¼ãƒ‹",num:95,pos:"DF"},
    {name:"ãƒ‡ã‚£ãƒãƒ«ã‚³",num:32,pos:"DF"},
    {name:"ãƒãƒ¬ãƒƒãƒ©",num:23,pos:"MF"},
    {name:"ãƒãƒ£ãƒ«ãƒãƒãƒ¼ãƒ«",num:20,pos:"MF"},
    {name:"ãƒ ãƒ’ã‚¿ãƒªãƒ£ãƒ³",num:22,pos:"MF"},
    {name:"ãƒ€ã‚¦ãƒ³ãƒ»ãƒ•ãƒ©ãƒƒãƒ†ã‚¸",num:16,pos:"MF"},
    {name:"ãƒ©ã‚¦ã‚¿ãƒ­ãƒ»ãƒãƒ«ãƒ†ã‚£ãƒã‚¹",num:10,pos:"FW"},
    {name:"ãƒãƒ«ã‚¯ã‚¹ãƒ»ãƒ†ãƒ¥ãƒ©ãƒ ",num:9,pos:"FW"},
    {name:"ã‚¢ã‚·ãƒ¥ãƒ©ãƒ•ãƒ»ãƒã‚­ãƒŸ",num:2,pos:"DF"},
    {name:"ãƒŸã‚­ã‚¿ãƒªã‚¢ãƒ³",num:22,pos:"MF"},
    {name:"ã‚¢ãƒ«ãƒŠã‚¦ãƒˆãƒ“ãƒƒãƒ",num:8,pos:"FW"},
    {name:"ã‚¯ã‚¢ãƒ‰ãƒ©ãƒ¼ãƒ‰",num:11,pos:"FW"},
  ],
  "ãƒŸãƒ©ãƒ³": [
    {name:"ãƒã‚¤ãƒ‹ãƒ£ãƒ³",num:16,pos:"GK"},
    {name:"ã‚«ãƒ©ãƒ–ãƒªã‚¢",num:2,pos:"DF"},
    {name:"ãƒãƒ¬ã‚¹ã‚«",num:19,pos:"DF"},
    {name:"ãƒˆãƒ¢ãƒª",num:23,pos:"DF"},
    {name:"ãƒ†ã‚ªãƒ»ã‚¨ãƒ«ãƒŠãƒ³ãƒ‡ã‚¹",num:19,pos:"DF"},
    {name:"ãƒ†ã‚£ã‚¸ãƒ£ãƒ‹ãƒ»ãƒ¬ã‚¤ãƒ³ãƒ‡ãƒ«ã‚¹",num:14,pos:"MF"},
    {name:"ã‚¤ã‚¹ãƒã‚¨ãƒ«ãƒ»ãƒ™ãƒ‹ãƒ£ãƒãƒ£ãƒ¼ãƒ«",num:5,pos:"MF"},
    {name:"ãƒ­ãƒ•ã‚¿ã‚¹=ãƒãƒ¼ã‚¯",num:8,pos:"MF"},
    {name:"ãƒ—ãƒªã‚·ãƒƒãƒ",num:11,pos:"FW"},
    {name:"ã‚¸ãƒ«ãƒ¼",num:9,pos:"FW"},
    {name:"ãƒ¬ã‚ªãƒ³",num:10,pos:"FW"},
    {name:"ãƒ—ãƒªã‚·ãƒƒãƒ",num:11,pos:"FW"},
    {name:"ã‚¢ãƒ–ãƒ©ãƒãƒ ",num:90,pos:"FW"},
    {name:"ãƒ•ãƒ­ãƒ•ã‚¹ã‚­ãƒ¼",num:7,pos:"FW"},
  ],
  "ãƒ‘ãƒªSG": [
    {name:"ãƒ‰ãƒ³ãƒŠãƒ«ãƒ³ãƒ",num:99,pos:"GK"},
    {name:"ã‚¢ã‚·ãƒ¥ãƒ©ãƒ•ãƒ»ãƒã‚­ãƒŸ",num:2,pos:"DF"},
    {name:"ãƒãƒ«ã‚­ãƒ¼ãƒ‹ãƒ§ã‚¹",num:5,pos:"DF"},
    {name:"ãƒ«ãƒ¼ã‚«ã‚¹ãƒ»ãƒ™ãƒ©ãƒ«ãƒ‰",num:11,pos:"DF"},
    {name:"ãƒŒãƒãƒ»ãƒ¡ãƒ³ãƒ‡ã‚¹",num:25,pos:"DF"},
    {name:"ãƒ•ã‚¡ãƒ“ã‚¢ãƒ³ãƒ»ãƒ«ã‚¤ã‚¹",num:8,pos:"MF"},
    {name:"ãƒ´ã‚£ãƒ†ã‚£ãƒ¼ãƒ‹ãƒ£",num:17,pos:"MF"},
    {name:"ã‚¦ã‚©ãƒ¼ãƒ¬ãƒ³ãƒ»ã‚¶ã‚¤ãƒ¬",num:33,pos:"MF"},
    {name:"ã‚¸ãƒ§ã‚¢ãƒ³ãƒ»ãƒãƒ™ã‚¹",num:87,pos:"MF"},
    {name:"ãƒ ãƒãƒƒãƒš",num:7,pos:"FW"},
    {name:"ãƒ©ãƒ³ãƒ€ãƒ«ãƒ»ã‚³ãƒ­ãƒ»ãƒ ã‚¢ãƒ‹",num:23,pos:"FW"},
    {name:"ã‚´ãƒ³ã‚µãƒ­ãƒ»ãƒ©ãƒ¢ã‚¹",num:9,pos:"FW"},
    {name:"ãƒ–ãƒ©ãƒ‰ãƒ¬ãƒ»ãƒãƒ«ã‚³ãƒ©",num:29,pos:"FW"},
    {name:"ãƒ‡ã‚·ãƒ¬ãƒ»ãƒ‰ã‚¦ã‚¨",num:11,pos:"FW"},
  ],
  "æµ¦å’Œãƒ¬ãƒƒã‚º": [
    {name:"è¥¿å·å‘¨ä½œ",num:1,pos:"GK"},
    {name:"é…’äº•å®æ¨¹",num:2,pos:"DF"},
    {name:"ã‚·ãƒ§ãƒ«ãƒ„",num:4,pos:"DF"},
    {name:"ãƒãƒªã‚¦ã‚¹ãƒ»ãƒ›ã‚¤ãƒ–ãƒ©ãƒ¼ãƒ†ãƒ³",num:5,pos:"DF"},
    {name:"å¤§ç•‘æ­©å¤¢",num:17,pos:"DF"},
    {name:"çŸ³åŸåºƒæ•™",num:24,pos:"DF"},
    {name:"ä¼Šè—¤æ•¦æ¨¹",num:8,pos:"MF"},
    {name:"å²©å°¾æ†²",num:3,pos:"MF"},
    {name:"å°æ³‰ä½³ç©‚",num:14,pos:"MF"},
    {name:"é–¢æ ¹è²´å¤§",num:19,pos:"FW"},
    {name:"æ¾å°¾ä½‘ä»‹",num:11,pos:"FW"},
    {name:"èˆˆæ¢ æ…ä¸‰",num:13,pos:"FW"},
    {name:"ãƒ›ã‚»ã‚«ãƒ³ãƒ†",num:9,pos:"FW"},
    {name:"ãƒã‚¢ã‚´ãƒ»ã‚µãƒ´ã‚£ã‚ª",num:20,pos:"FW"},
    {name:"ã‚°ã‚¹ã‚¿ãƒ•ã‚½ãƒ³",num:21,pos:"MF"},
  ],
  "é¹¿å³¶ã‚¢ãƒ³ãƒˆãƒ©ãƒ¼ã‚º": [
    {name:"æ—©å·å‹åŸº",num:1,pos:"GK"},
    {name:"å¸¸æœ¬ä½³å¾",num:22,pos:"DF"},
    {name:"æ¤ç”°ç›´é€š",num:4,pos:"DF"},
    {name:"é–¢å·éƒä¸‡",num:3,pos:"DF"},
    {name:"å®‰è¥¿å¹¸è¼",num:16,pos:"DF"},
    {name:"ä¸‰ç«¿å¥æ–—",num:20,pos:"MF"},
    {name:"ä½é‡æµ·èˆŸ",num:8,pos:"MF"},
    {name:"æ¨‹å£é›„å¤ª",num:7,pos:"MF"},
    {name:"åå¤æ–°å¤ªéƒ",num:17,pos:"MF"},
    {name:"å¸«å²¡æŸŠç”Ÿ",num:37,pos:"MF"},
    {name:"éˆ´æœ¨å„ªç£¨",num:40,pos:"FW"},
    {name:"çŸ¥å¿µæ…¶",num:9,pos:"FW"},
    {name:"å£ç”°è£•æš‰",num:30,pos:"FW"},
    {name:"æ¾æ‘å„ªå¤ª",num:18,pos:"FW"},
    {name:"ãƒãƒ£ãƒ´ãƒªãƒƒãƒ",num:11,pos:"FW"},
  ],
  "æ¨ªæµœFãƒ»ãƒãƒªãƒã‚¹": [
    {name:"ä¸€æ£®ç´”",num:1,pos:"GK"},
    {name:"æ¾åŸå¥",num:2,pos:"DF"},
    {name:"ã‚¨ãƒ‰ã‚¥ã‚¢ãƒ«ãƒ‰",num:5,pos:"DF"},
    {name:"ä¸Šå³¶æ‹“å·³",num:4,pos:"DF"},
    {name:"å°æ± é¾å¤ª",num:3,pos:"DF"},
    {name:"æ¸¡è¾ºçš“å¤ª",num:14,pos:"MF"},
    {name:"å–œç”°æ‹“ä¹Ÿ",num:6,pos:"MF"},
    {name:"è¥¿æ‘æ‹“çœŸ",num:18,pos:"MF"},
    {name:"ã‚¨ã‚¦ãƒ™ãƒ«",num:11,pos:"FW"},
    {name:"ã‚¢ãƒ³ãƒ‡ãƒ«ã‚½ãƒ³ãƒ»ãƒ­ãƒšã‚¹",num:9,pos:"FW"},
    {name:"ãƒ¤ãƒ³ãƒ»ãƒãƒ†ã‚¦ã‚¹",num:7,pos:"FW"},
    {name:"æ¤ä¸­æœæ—¥",num:19,pos:"FW"},
    {name:"å®®å¸‚äº®",num:23,pos:"FW"},
    {name:"æ°¸æˆ¸å‹ä¹Ÿ",num:13,pos:"DF"},
    {name:"å¤©é‡ç´”",num:25,pos:"MF"},
  ],
  "FCæ±äº¬": [
    {name:"ã‚¹ã‚¦ã‚©ãƒ“ã‚¯",num:1,pos:"GK"},
    {name:"é•·å‹ä½‘éƒ½",num:5,pos:"DF"},
    {name:"æœ¨æœ¬æ­ç”Ÿ",num:3,pos:"DF"},
    {name:"æ£®é‡çœŸäºº",num:4,pos:"DF"},
    {name:"ãƒãƒ³ã‚°ãƒ¼ãƒŠã‚¬ãƒ³ãƒ‡ä½³å²æ‰¶",num:15,pos:"DF"},
    {name:"è’æœ¨é¼å¤ªéƒ",num:10,pos:"MF"},
    {name:"æ±æ…¶æ‚Ÿ",num:8,pos:"MF"},
    {name:"å®‰éƒ¨æŸŠæ–—",num:16,pos:"MF"},
    {name:"ä¿µç©ç”°æ™ƒå¤ª",num:35,pos:"MF"},
    {name:"ä»²å·è¼äºº",num:11,pos:"FW"},
    {name:"ãƒ‡ã‚£ã‚¨ã‚´ãƒ»ã‚ªãƒªãƒ´ã‚§ã‚¤ãƒ©",num:9,pos:"FW"},
    {name:"æ¸¡é‚Šå‡Œç£¨",num:41,pos:"MF"},
    {name:"é è—¤æ¸“å¤ª",num:7,pos:"FW"},
    {name:"å°æŸå‰›",num:11,pos:"FW"},
    {name:"ãƒ¬ã‚¢ãƒ³ãƒ‰ãƒ­",num:8,pos:"FW"},
  ],
  "å·å´ãƒ•ãƒ­ãƒ³ã‚¿ãƒ¼ãƒ¬": [
    {name:"ä¸Šç¦å…ƒç›´äºº",num:1,pos:"GK"},
    {name:"å±±æ ¹è¦–æ¥",num:2,pos:"DF"},
    {name:"è°·å£å½°æ‚Ÿ",num:5,pos:"DF"},
    {name:"è»Šå±‹ç´³å¤ªéƒ",num:7,pos:"DF"},
    {name:"ä½ã€…æœ¨æ—­",num:15,pos:"DF"},
    {name:"æ©˜ç”°å¥äºº",num:16,pos:"MF"},
    {name:"è„‡å‚æ³°æ–—",num:14,pos:"MF"},
    {name:"å®¶é•·æ˜­åš",num:41,pos:"MF"},
    {name:"ç€¬å·ç¥è¼”",num:19,pos:"FW"},
    {name:"ãƒãƒ«ã‚·ãƒ¼ãƒ‹ãƒ§",num:23,pos:"FW"},
    {name:"å±±ç”°æ–°",num:30,pos:"FW"},
    {name:"ã‚¨ãƒªã‚½ãƒ³",num:9,pos:"FW"},
    {name:"å®®ä»£å¤§è–",num:18,pos:"FW"},
    {name:"é é‡å¤§å¼¥",num:11,pos:"MF"},
    {name:"ãƒãƒ£ãƒŠãƒ†ã‚£ãƒƒãƒ—",num:10,pos:"MF"},
  ],
  "ã‚¬ãƒ³ãƒå¤§é˜ª": [
    {name:"æ±å£é †æ˜­",num:1,pos:"GK"},
    {name:"ä¸‰æµ¦å¼¦å¤ª",num:3,pos:"DF"},
    {name:"ã‚¯ã‚©ãƒ³ãƒ»ã‚®ãƒ§ãƒ³ã‚¦ã‚©ãƒ³",num:5,pos:"DF"},
    {name:"åŠç”°é™¸",num:17,pos:"DF"},
    {name:"é»’å·åœ­ä»‹",num:7,pos:"DF"},
    {name:"ãƒ€ãƒ¯ãƒ³",num:4,pos:"MF"},
    {name:"é½Šè—¤æœªæœˆ",num:8,pos:"MF"},
    {name:"å®‡ä½ç¾è²´å²",num:39,pos:"FW"},
    {name:"ã‚¦ã‚§ãƒ«ãƒˆãƒ³",num:11,pos:"FW"},
    {name:"å±±ä¸‹è«’ä¹Ÿ",num:19,pos:"FW"},
    {name:"é£Ÿé‡äº®å¤ªéƒ",num:33,pos:"FW"},
    {name:"éˆ´æœ¨æ­¦è”µ",num:9,pos:"FW"},
    {name:"å‚æœ¬ä¸€å½©",num:16,pos:"FW"},
    {name:"æ±Ÿå·æ¹§æ¸…",num:2,pos:"DF"},
    {name:"å²¸æœ¬æ­¦æµ",num:28,pos:"MF"},
  ],
  "æ—¥æœ¬": [
    {name:"éˆ´æœ¨å½©è‰¶",num:1,pos:"GK"},
    {name:"å¤§è¿«æ•¬ä»‹",num:12,pos:"GK"},
    {name:"è…åŸç”±å‹¢",num:2,pos:"DF"},
    {name:"å†¨å®‰å¥æ´‹",num:3,pos:"DF"},
    {name:"æ¿å€‰æ»‰",num:4,pos:"DF"},
    {name:"è°·å£å½°æ‚Ÿ",num:22,pos:"DF"},
    {name:"é•·è°·éƒ¨èª ",num:17,pos:"DF"},
    {name:"ä¸­å±±é›„å¤ª",num:5,pos:"DF"},
    {name:"é è—¤èˆª",num:6,pos:"MF"},
    {name:"å®ˆç”°è‹±æ­£",num:14,pos:"MF"},
    {name:"ç”°ä¸­ç¢§",num:17,pos:"MF"},
    {name:"éŒç”°å¤§åœ°",num:16,pos:"MF"},
    {name:"ä¸‰ç¬˜è–«",num:9,pos:"FW"},
    {name:"ä¹…ä¿å»ºè‹±",num:10,pos:"FW"},
    {name:"ä¼Šæ±ç´”ä¹Ÿ",num:8,pos:"FW"},
    {name:"ä¸Šç”°ç¶ºä¸–",num:15,pos:"FW"},
    {name:"å‰ç”°å¤§ç„¶",num:13,pos:"FW"},
    {name:"å—é‡æ‹“å®Ÿ",num:11,pos:"FW"},
    {name:"æµ…é‡æ‹“ç£¨",num:18,pos:"FW"},
    {name:"å ‚å®‰å¾‹",num:7,pos:"FW"},
    {name:"è¥¿æ‘æ‹“çœŸ",num:19,pos:"FW"},
  ],
  "ãƒ–ãƒ©ã‚¸ãƒ«": [
    {name:"ã‚¢ãƒªã‚½ãƒ³",num:1,pos:"GK"},
    {name:"ã‚¨ãƒ‡ãƒ«ã‚½ãƒ³",num:23,pos:"GK"},
    {name:"ãƒ€ãƒ‹ãƒ¼ãƒ­",num:2,pos:"DF"},
    {name:"ã‚«ã‚»ãƒŸãƒ­",num:5,pos:"MF"},
    {name:"ãƒã‚¢ã‚´ãƒ»ã‚·ã‚¦ãƒ",num:3,pos:"DF"},
    {name:"ãƒãƒ«ã‚­ãƒ¼ãƒ‹ãƒ§ã‚¹",num:4,pos:"DF"},
    {name:"ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹ãƒ»ã‚µãƒ³ãƒ‰ãƒ­",num:6,pos:"DF"},
    {name:"ãƒ•ãƒ¬ãƒƒã‚¸",num:15,pos:"MF"},
    {name:"ãƒ•ã‚¡ãƒ“ãƒ¼ãƒ‹ãƒ§",num:13,pos:"MF"},
    {name:"ãƒ«ãƒ¼ã‚«ã‚¹ãƒ»ãƒ‘ã‚±ã‚¿",num:10,pos:"MF"},
    {name:"ãƒ´ã‚£ãƒ‹ã‚·ã‚¦ã‚¹",num:20,pos:"FW"},
    {name:"ãƒ­ãƒ‰ãƒªã‚´",num:11,pos:"FW"},
    {name:"ãƒã‚¤ãƒãƒ¼ãƒ«",num:10,pos:"FW"},
    {name:"ã‚¬ãƒ–ãƒªã‚¨ãƒ«ãƒ»ã‚¸ã‚§ã‚ºãƒ¼ã‚¹",num:9,pos:"FW"},
    {name:"ãƒªã‚·ãƒ£ãƒ«ãƒªã‚½ãƒ³",num:19,pos:"FW"},
    {name:"ã‚¬ãƒ–ãƒªã‚¨ãƒ«ãƒ»ãƒãƒ«ãƒ†ã‚£ãƒãƒª",num:17,pos:"FW"},
  ],
  "ãƒ•ãƒ©ãƒ³ã‚¹": [
    {name:"ãƒ­ãƒªã‚¹",num:1,pos:"GK"},
    {name:"ãƒã‚¤ãƒ‹ãƒ£ãƒ³",num:16,pos:"GK"},
    {name:"ãƒ‘ãƒ´ã‚¡ãƒ¼ãƒ«",num:2,pos:"DF"},
    {name:"ãƒ´ã‚¡ãƒ©ãƒ³",num:4,pos:"DF"},
    {name:"ã‚­ãƒ£ãƒªã‚¢ãƒ³ãƒ»ãƒ ãƒãƒƒãƒš",num:10,pos:"FW"},
    {name:"ãƒ†ã‚ªãƒ»ã‚¨ãƒ«ãƒŠãƒ³ãƒ‡ã‚¹",num:22,pos:"DF"},
    {name:"ã‚¨ãƒ ãƒãƒš",num:10,pos:"FW"},
    {name:"ãƒ©ãƒ“ã‚ª",num:8,pos:"MF"},
    {name:"ã‚°ãƒªãƒ¼ã‚ºãƒãƒ³",num:7,pos:"FW"},
    {name:"ã‚¸ãƒ«ãƒ¼",num:9,pos:"FW"},
    {name:"ã‚³ãƒŠãƒ†",num:5,pos:"DF"},
    {name:"ã‚«ãƒãƒ´ã‚£ãƒ³ã‚¬",num:16,pos:"MF"},
    {name:"ãƒ‡ãƒ³ãƒ™ãƒ¬",num:11,pos:"FW"},
    {name:"ã‚«ãƒ³ãƒ†",num:13,pos:"MF"},
    {name:"ãƒã‚°ãƒ",num:6,pos:"MF"},
    {name:"ãƒ™ãƒ³ã‚¼ãƒ",num:19,pos:"FW"},
  ],
  "ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³": [
    {name:"ã‚¨ãƒŸãƒªã‚¢ãƒ¼ãƒãƒ»ãƒãƒ«ãƒ†ã‚£ãƒã‚¹",num:23,pos:"GK"},
    {name:"ãƒ¢ãƒªãƒ¼ãƒŠ",num:26,pos:"DF"},
    {name:"ã‚¯ãƒªã‚¹ãƒ†ã‚£ã‚¢ãƒ³ãƒ»ãƒ­ãƒ¡ãƒ­",num:13,pos:"DF"},
    {name:"ãƒªã‚µãƒ³ãƒ‰ãƒ­ãƒ»ãƒãƒ«ãƒ†ã‚£ãƒã‚¹",num:25,pos:"DF"},
    {name:"ã‚¿ã‚°ãƒªã‚¢ãƒ•ã‚£ã‚³",num:3,pos:"DF"},
    {name:"ãƒ‡ãƒ»ãƒ‘ã‚¦ãƒ«",num:7,pos:"MF"},
    {name:"ã‚¨ãƒ³ã‚½ãƒ»ãƒ•ã‚§ãƒ«ãƒŠãƒ³ãƒ‡ã‚¹",num:24,pos:"MF"},
    {name:"ãƒãƒƒã‚¯ãƒ»ã‚¢ãƒªã‚¹ã‚¿ãƒ¼",num:20,pos:"MF"},
    {name:"ã‚¸ãƒ¥ãƒªã‚¢ãƒ³ãƒ»ã‚¢ãƒ«ãƒãƒ¬ã‚¹",num:9,pos:"FW"},
    {name:"ãƒ¡ãƒƒã‚·",num:10,pos:"FW"},
    {name:"ãƒ©ã‚¦ã‚¿ãƒ­ãƒ»ãƒãƒ«ãƒ†ã‚£ãƒã‚¹",num:22,pos:"FW"},
    {name:"ãƒ‡ã‚£ãƒ»ãƒãƒªã‚¢",num:11,pos:"FW"},
    {name:"ãƒ­ãƒ»ãƒã‚§ãƒ«ã‚½",num:18,pos:"MF"},
    {name:"ã‚³ãƒ¬ã‚¢",num:19,pos:"FW"},
  ],
  "ãƒ‰ã‚¤ãƒ„": [
    {name:"ãƒã‚¤ã‚¢ãƒ¼",num:1,pos:"GK"},
    {name:"ãƒ†ã‚¢ãƒ»ã‚·ãƒ¥ãƒ†ãƒ¼ã‚²ãƒ³",num:12,pos:"GK"},
    {name:"ã‚­ãƒŸãƒƒãƒ’",num:6,pos:"DF"},
    {name:"ãƒªãƒ¥ãƒ‡ã‚£ã‚¬ãƒ¼",num:2,pos:"DF"},
    {name:"ã‚¸ãƒ¥ãƒ¼ãƒ«",num:16,pos:"DF"},
    {name:"ãƒ©ã‚¦ãƒ ",num:3,pos:"DF"},
    {name:"ã‚´ãƒ¬ãƒ„ã‚«",num:8,pos:"MF"},
    {name:"ãƒãƒ¥ã‚¢ãƒ¡ãƒ‹",num:0,pos:"MF"},
    {name:"ã‚¯ãƒ­ãƒ¼ã‚¹",num:8,pos:"MF"},
    {name:"ãƒ ã‚·ã‚¢ãƒ©",num:10,pos:"MF"},
    {name:"ãƒãƒ´ã‚¡ãƒ¼ãƒ„",num:7,pos:"MF"},
    {name:"ãƒ ãƒ©ãƒ¼ãƒ‹ãƒ¼",num:13,pos:"MF"},
    {name:"ãƒ‹ãƒ£ãƒ–ãƒª",num:9,pos:"FW"},
    {name:"ãƒ´ã‚§ãƒ«ãƒŠãƒ¼",num:11,pos:"FW"},
    {name:"ãƒ•ãƒ¥ãƒ«ã‚¯ãƒ«ãƒ¼ã‚¯",num:19,pos:"FW"},
  ],
  "ã‚¹ãƒšã‚¤ãƒ³": [
    {name:"ã‚·ãƒ¢ãƒ³",num:23,pos:"GK"},
    {name:"ã‚«ãƒ«ãƒãƒãƒ«",num:2,pos:"DF"},
    {name:"ãƒ‘ã‚¦ãƒ»ãƒˆãƒ¼ãƒ¬ã‚¹",num:4,pos:"DF"},
    {name:"ãƒ©ãƒãƒ«ã‚¿",num:24,pos:"DF"},
    {name:"ã‚°ãƒªãƒãƒ«ãƒ‰",num:3,pos:"DF"},
    {name:"ãƒ•ã‚¡ãƒ“ã‚¢ãƒ³ãƒ»ãƒ«ã‚¤ã‚¹",num:8,pos:"MF"},
    {name:"ãƒ­ãƒ‰ãƒª",num:16,pos:"MF"},
    {name:"ãƒšãƒ‰ãƒª",num:26,pos:"MF"},
    {name:"ãƒ¤ãƒãƒ«",num:19,pos:"FW"},
    {name:"ãƒ‹ã‚³ãƒ»ã‚¦ã‚£ãƒªã‚¢ãƒ ã‚¹",num:17,pos:"FW"},
    {name:"ãƒ¢ãƒ©ã‚¿",num:7,pos:"FW"},
    {name:"ã‚ªãƒ«ãƒ¢",num:10,pos:"MF"},
    {name:"ãƒ•ã‚©ãƒ•ã‚¡ãƒŠ",num:22,pos:"DF"},
    {name:"ãƒŸã‚±ãƒ«ãƒ»ãƒ¡ãƒªãƒ¼ãƒ",num:18,pos:"MF"},
  ],
};

function getPresetPlayers(teamName) {
  const players = TEAM_PRESETS[teamName];
  if (players && players.length > 0) return players;
  return [];
}


// ============================================================
// PLAYER LIST RENDER
// ============================================================
function renderPlayerList() {
  const list = document.getElementById('playerList');
  const filter = document.getElementById('playerSearchInput').value.toLowerCase().trim();

  if (!allPlayers.length) {
    list.innerHTML = '<div style="color:var(--text-dim);font-size:0.78rem;padding:8px;text-align:center;">'
      + (filter ? 'é¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒãƒ¼ãƒ ã‚’é¸æŠã™ã‚‹ã¨æ¨ªæ–­æ¤œç´¢ã§ãã¾ã™ï¼‰' : 'ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„')
      + '</div>';
    return;
  }

  const inLineup = new Set(Object.values(lineup).filter(Boolean).map(p => p.name));
  const filtered = allPlayers.filter(p => {
    if (!filter) return true;
    if (p.name && p.name.toLowerCase().includes(filter)) return true;
    if (p.pos && p.pos.toLowerCase().includes(filter)) return true;
    if (p.num && String(p.num).includes(filter)) return true;
    return false;
  });

  list.innerHTML = '';
  filtered.forEach(p => {
    const div = document.createElement('div');
    const isIn = inLineup.has(p.name);
    div.className = 'player-item' + (isIn ? ' in-lineup' : '');
    div.innerHTML = `
      <span class="p-num">${p.num||''}</span>
      <div class="p-avatar">${renderAvatar(p)}</div>
      <div class="p-info">
        <div class="p-name">${p.name}</div>
        <div class="p-meta">${p.pos||''}${isIn?' Â· é…ç½®æ¸ˆ':''}${p.custom?' Â· ã‚«ã‚¹ã‚¿ãƒ ':''}</div>
      </div>
      ${p.custom ? `<button class="p-del" title="å‰Šé™¤" onclick="deleteCustomPlayer('${p.name}',event)">âœ•</button>` : ''}
    `;
    if (!isIn) {
      div.onclick = () => openSlotPicker(p);
      // D&D: é¸æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ”ãƒƒãƒãƒ»ãƒ™ãƒ³ãƒã¸ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
      div.draggable = true;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('text/plain', JSON.stringify({src:'playerList', player: p}));
        setTimeout(() => div.classList.add('dragging-src'), 0);
      });
      div.addEventListener('dragend', () => div.classList.remove('dragging-src'));
      div.addEventListener('touchstart', e => onTouchStart(e, null, 'playerList', activeTeam, p), {passive:false});
    }
    list.appendChild(div);
  });
}

function filterPlayerList() {
  renderPlayerList();
}

function renderAvatar(p) {
  if (p.img) {
    return `<img src="${p.img}" onerror="this.parentNode.innerHTML='${getInitials(p.name)}'" loading="lazy">`;
  }
  return getInitials(p.name);
}

function getInitials(name) {
  if (!name) return 'ğŸ‘¤';
  const words = name.trim().split(/\s+/);
  if (words.length >= 2) return (words[0][0] + words[words.length-1][0]).toUpperCase();
  return name.slice(0, 2).toUpperCase();
}

// ============================================================
// PITCH RENDER
// ============================================================

// ============================================================
// PLACEMENT MODE: player-first or position-first
// ============================================================
let placementMode = 'player'; // 'player' | 'position'

function setPlacementMode(mode) {
  placementMode = mode;
  document.getElementById('modePlayerFirst').classList.toggle('active', mode === 'player');
  document.getElementById('modePosFirst').classList.toggle('active', mode === 'position');
  document.getElementById('playerPickerPanel').style.display = mode === 'player' ? 'flex' : 'none';
  document.getElementById('positionPickerPanel').style.display = mode === 'position' ? 'flex' : 'none';
  if (mode === 'position') renderPositionList();
}

function renderPositionList() {
  const list = document.getElementById('positionList');
  list.innerHTML = '';
  const isAway = activeTeam === 'away';
  const tLineup = isAway ? opponentLineup : lineup;
  const tFormation = isAway ? opponentFormation : currentFormation;
  const positions = FORMATIONS[tFormation].positions;

  positions.forEach((pos, i) => {
    const player = tLineup[i];
    const btn = document.createElement('button');
    btn.className = 'pos-slot-btn' + (player ? ' slot-filled' : '');

    const badgeEl = document.createElement('div');
    badgeEl.className = 'pos-badge' + (player ? '' : ' empty');
    if (player && player.img) {
      const img = document.createElement('img');
      img.src = player.img;
      img.onerror = function() { this.outerHTML = '<span>' + getInitials(player.name) + '</span>'; };
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      badgeEl.appendChild(img);
    } else if (player) {
      badgeEl.textContent = getInitials(player.name);
    } else {
      badgeEl.textContent = pos.role;
    }

    const infoEl = document.createElement('div');
    infoEl.style.cssText = 'flex:1;min-width:0;text-align:left;';
    infoEl.innerHTML = '<div style="font-size:0.8rem;font-weight:700;">'
      + (player ? player.name : 'â€” æœªé¸æŠ â€”')
      + '</div><div style="font-size:0.65rem;color:var(--text-dim);">'
      + pos.role
      + (player ? ' Â· ' + player.pos : '')
      + '</div>';

    btn.appendChild(badgeEl);
    btn.appendChild(infoEl);

    if (player) {
      const clearBtn = document.createElement('span');
      clearBtn.style.cssText = 'color:var(--text-dim);font-size:0.75rem;padding:0 4px;cursor:pointer;';
      clearBtn.textContent = 'âœ•';
      clearBtn.onclick = (e) => {
        e.stopPropagation();
        if (isAway) delete opponentLineup[i]; else delete lineup[i];
        renderPitch(); renderLineupList(); renderPositionList(); updateLineupCount();
      };
      btn.appendChild(clearBtn);
    }

    btn.onclick = () => openSlotModal(i, activeTeam);
    list.appendChild(btn);
  });
}
function renderPitch() {
  renderTeamPitch('home');
  if (opponentEnabled) renderTeamPitch('away');
  updateLineupCount();
  if (typeof placementMode !== 'undefined' && placementMode === 'position') {
    renderPositionList();
  }
}

function renderTeamPitch(team) {
  const isHome = team === 'home';
  const containerId = isHome ? 'pitchPlayers' : 'opponentPitchPlayers';
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  const tLineup = isHome ? lineup : opponentLineup;
  const tFormation = isHome ? currentFormation : opponentFormation;
  const positions = FORMATIONS[tFormation].positions;

  positions.forEach((pos, i) => {
    const player = tLineup[i];
    const div = document.createElement('div');
    div.className = 'pitch-player';
    div.dataset.slot = i;
    div.dataset.team = team;
    div.style.left = pos.x + '%';
    div.style.top = pos.y + '%';

    const uid = team + '_' + i;
    if (player) {
      const initials = getInitials(player.name);
      div.innerHTML = `
        <div class="pp-icon" id="ppicon-${uid}">
          ${player.img
            ? `<img src="${player.img}" onerror="this.onerror=null;this.style.display='none';document.getElementById('ppinitials-${uid}').style.display='flex';" loading="lazy" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
            : ''}
          <span id="ppinitials-${uid}" style="display:${player.img?'none':'flex'};font-size:0.7rem;font-weight:700;align-items:center;justify-content:center;width:100%;height:100%;border-radius:50%;">${initials}</span>
          ${player.num ? `<span class="pp-badge">${player.num}</span>` : ''}
          <button class="pp-remove" onclick="removePlayer(${i},'${team}',event)">âœ•</button>
        </div>
        <div class="pp-label" ondblclick="editPlayerName(${i},'${team}',event)" title="ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§åå‰ç·¨é›†">${shortName(player.name)}</div>
      `;
    } else {
      div.innerHTML = `
        <div class="pp-icon empty">${pos.role}</div>
        <div class="pp-label empty">ã‚¯ãƒªãƒƒã‚¯ã—ã¦é…ç½®</div>
      `;
    }
    div.onclick = (e) => {
      if (e.target.classList.contains('pp-remove')) return;
      if (dragState && dragState.active) return;
      if (opponentEnabled) setActiveTeam(team);
      openSlotModal(i, team);
    };
    if (player) {
      div.draggable = true;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', JSON.stringify({src:'pitch',slot:i,team}));
        dragState.active = true; dragState.slot = i;
        setTimeout(() => div.classList.add('dragging'), 0);
      });
      div.addEventListener('dragend', e => {
        dragState.active = false;
        document.querySelectorAll('.dragging,.drag-over').forEach(el => el.classList.remove('dragging','drag-over'));
      });
    }
    div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
    div.addEventListener('dragleave', e => div.classList.remove('drag-over'));
    div.addEventListener('drop', e => {
      e.preventDefault();
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      try {
        const d = JSON.parse(e.dataTransfer.getData('text/plain'));
        const tL = team==='away' ? opponentLineup : lineup;
        if ((d.src==='pitch'||d.src==='lineup') && d.team===team && d.slot !== i) {
          // ãƒ”ãƒƒãƒå†…ãƒ»ãƒªã‚¹ãƒˆå†…ã§ã®ã‚¹ãƒ¯ãƒƒãƒ—
          const tmp=tL[d.slot]; tL[d.slot]=tL[i]; tL[i]=tmp;
          renderPitch(); renderLineupList(); renderPlayerList(); updateLineupCount();
        } else if (d.src==='playerList' && d.player) {
          // é¸æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ”ãƒƒãƒã¸é…ç½®
          const inLineup = Object.values(tL).filter(Boolean).map(p=>p.name);
          if (!inLineup.includes(d.player.name)) {
            tL[i] = d.player;
            renderPitch(); renderLineupList(); renderPlayerList(); updateLineupCount();
          }
        } else if (d.src==='bench' && d.team===team) {
          // ãƒ™ãƒ³ãƒã‹ã‚‰ãƒ”ãƒƒãƒã¸äº¤ä»£
          const tB = team==='away' ? opponentBench : bench;
          const benchPlayer = tB[d.benchIdx];
          if (benchPlayer) {
            const old = tL[i] || null;
            tL[i] = benchPlayer;
            tB[d.benchIdx] = old;
            renderPitch(); renderLineupList(); updateLineupCount();
          }
        }
      } catch(ex) {}
      dragState.active = false;
    });
    div.addEventListener('touchstart', e => onTouchStart(e, i, 'pitch', team), {passive:false});
    container.appendChild(div);
  });
}

function shortName(name) {
  if (!name) return '';
  if (name.length <= 6) return name;
  const parts = name.split(/[\sãƒ»]/);
  if (parts.length >= 2) return parts[parts.length-1];
  return name.slice(0, 6);
}

function removePlayer(slotIdx, team, e) {
  e.stopPropagation();
  if (team === 'away') delete opponentLineup[slotIdx]; else delete lineup[slotIdx];
  renderPitch();
  renderLineupList();
  renderPlayerList();
}

function updateLineupCount() {
  const isAway = activeTeam === 'away';
  const tLineup = isAway ? opponentLineup : lineup;
  const tBench = isAway ? opponentBench : bench;
  const tFormation = isAway ? opponentFormation : currentFormation;
  const starters = Object.keys(tLineup).length;
  const benchers = tBench.filter(Boolean).length;
  const total = FORMATIONS[tFormation].positions.length;
  document.getElementById('lineupCount').textContent = `ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ ${starters}/${total}äººã€€ãƒ™ãƒ³ãƒ ${benchers}/5äºº`;
}

// ============================================================
// LINEUP LIST (right panel)
// ============================================================
function renderLineupList() {
  const list = document.getElementById('lineupList');
  list.innerHTML = '';
  const isAway = activeTeam === 'away';
  const tLineup = isAway ? opponentLineup : lineup;
  const tFormation = isAway ? opponentFormation : currentFormation;
  const tBench = isAway ? opponentBench : bench;
  const team = activeTeam;

  const positions = FORMATIONS[tFormation].positions;
  positions.forEach((pos, idx) => {
    const player = tLineup[idx];
    const div = document.createElement('div');
    div.className = 'lineup-slot' + (player ? ' filled' : '');
    div.onclick = () => openSlotModal(idx, team);
    div.title = player ? 'ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´' : 'ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ';

    const initials = player ? getInitials(player.name) : '+';
    const iconEl = document.createElement('div');
    iconEl.className = 'ls-icon';
    if (player && player.img) {
      const img = document.createElement('img');
      img.src = player.img;
      img.loading = 'lazy';
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      img.onerror = function() { this.outerHTML = '<span>' + initials + '</span>'; };
      iconEl.appendChild(img);
    } else {
      iconEl.textContent = initials;
    }

    const numEl = document.createElement('span');
    numEl.className = 'ls-num';
    numEl.textContent = idx + 1;

    const infoEl = document.createElement('div');
    infoEl.className = 'ls-info';
    infoEl.innerHTML = '<div class="ls-name">' + (player ? player.name : 'â€” æœªé¸æŠ â€”') + '</div>'
      + '<div class="ls-pos">' + pos.role + (player ? ' Â· ' + player.pos : '') + '</div>';

    div.appendChild(numEl);
    div.appendChild(iconEl);
    div.appendChild(infoEl);

    if (player) {
      const clearBtn = document.createElement('button');
      clearBtn.className = 'ls-clear';
      clearBtn.textContent = 'âœ•';
      clearBtn.title = 'å¤–ã™';
      clearBtn.onclick = function(e) {
        e.stopPropagation();
        if (isAway) delete opponentLineup[idx]; else delete lineup[idx];
        renderPitch(); renderLineupList(); updateLineupCount();
      };
      div.appendChild(clearBtn);
      div.draggable = true;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', JSON.stringify({src:'lineup',slot:idx,team}));
        dragState.active = true;
        setTimeout(() => div.classList.add('dragging'), 0);
      });
      div.addEventListener('dragend', e => {
        dragState.active = false;
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
      });
    }
    div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
    div.addEventListener('dragleave', e => div.classList.remove('drag-over'));
    div.addEventListener('drop', e => {
      e.preventDefault(); div.classList.remove('drag-over');
      try {
        const d = JSON.parse(e.dataTransfer.getData('text/plain'));
        if ((d.src==='pitch'||d.src==='lineup') && d.team===team && d.slot !== idx) {
          const tL = isAway ? opponentLineup : lineup;
          const tmp=tL[d.slot]; tL[d.slot]=tL[idx]; tL[idx]=tmp;
          renderPitch(); renderLineupList(); updateLineupCount();
        }
      } catch(ex) {}
      dragState.active = false;
    });
    div.addEventListener('touchstart', e => onTouchStart(e, idx, 'lineup', team), {passive:false});
    list.appendChild(div);
  });

  // â”€â”€ BENCH SECTION â”€â”€
  const benchLabel = document.createElement('div');
  benchLabel.className = 'lineup-section-label bench-label';
  benchLabel.textContent = 'BENCH';
  list.appendChild(benchLabel);

  tBench.forEach((player, bi) => {
    const div = document.createElement('div');
    div.className = 'lineup-slot bench-slot' + (player ? ' filled' : '');
    div.dataset.bench = '1';
    div.dataset.benchIdx = bi;
    div.onclick = () => openBenchModal(bi, team);
    div.title = player ? 'ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´' : 'ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ';

    const initials = player ? getInitials(player.name) : 'B';
    const numEl = document.createElement('span');
    numEl.className = 'ls-num bench-num';
    numEl.textContent = 'B' + (bi + 1);

    const iconEl = document.createElement('div');
    iconEl.className = 'ls-icon';
    if (player && player.img) {
      const img = document.createElement('img');
      img.src = player.img;
      img.loading = 'lazy';
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      img.onerror = function() { this.outerHTML = '<span>' + initials + '</span>'; };
      iconEl.appendChild(img);
    } else {
      iconEl.textContent = initials;
    }

    const infoEl = document.createElement('div');
    infoEl.className = 'ls-info';
    infoEl.innerHTML = '<div class="ls-name">' + (player ? player.name : 'â€” æœªé¸æŠ â€”') + '</div>'
      + '<div class="ls-pos">' + (player ? player.pos + ' Â· ãƒ™ãƒ³ãƒ' : 'ãƒ™ãƒ³ãƒ') + '</div>';

    div.appendChild(numEl);
    div.appendChild(iconEl);
    div.appendChild(infoEl);

    if (player) {
      const swapBtn = document.createElement('button');
      swapBtn.className = 'ls-swap';
      swapBtn.textContent = 'â‡„';
      swapBtn.title = 'ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã¨äº¤ä»£';
      swapBtn.onclick = function(e) { e.stopPropagation(); openSwapModal(bi, team); };
      div.appendChild(swapBtn);

      const clearBtn = document.createElement('button');
      clearBtn.className = 'ls-clear';
      clearBtn.textContent = 'âœ•';
      clearBtn.onclick = function(e) {
        e.stopPropagation();
        if (isAway) opponentBench[bi] = null; else bench[bi] = null;
        renderLineupList(); updateLineupCount();
      };
      div.appendChild(clearBtn);

      // D&D: ãƒ™ãƒ³ãƒâ†’ãƒ”ãƒƒãƒã¸ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
      div.draggable = true;
      div.addEventListener('dragstart', e => {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', JSON.stringify({src:'bench', benchIdx:bi, team}));
        dragState.active = true;
        setTimeout(() => div.classList.add('dragging'), 0);
      });
      div.addEventListener('dragend', e => {
        dragState.active = false;
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
      });
    }
    // ãƒ™ãƒ³ãƒã‚¹ãƒ­ãƒƒãƒˆã®dropå¯¾å¿œï¼ˆé¸æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ™ãƒ³ãƒã¸ï¼‰
    div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drag-over'); });
    div.addEventListener('dragleave', e => div.classList.remove('drag-over'));
    div.addEventListener('drop', e => {
      e.preventDefault(); div.classList.remove('drag-over');
      try {
        const d = JSON.parse(e.dataTransfer.getData('text/plain'));
        const tB = isAway ? opponentBench : bench;
        const tL = isAway ? opponentLineup : lineup;
        if (d.src === 'playerList' && d.player) {
          const inBench = tB.filter(Boolean).map(p=>p.name);
          const inLineup = Object.values(tL).filter(Boolean).map(p=>p.name);
          if (!inBench.includes(d.player.name) && !inLineup.includes(d.player.name)) {
            tB[bi] = d.player;
            renderLineupList(); renderPlayerList(); updateLineupCount();
          }
        }
      } catch(ex) {}
    });
    div.addEventListener('touchstart', e => onTouchStart(e, bi, 'bench', team), {passive:false});
    list.appendChild(div);
  });
}

// ============================================================
// MODAL: SLOT PICKER
// ============================================================
function openSlotModal(slotIdx, team) {
  activeModalMode = 'slot';
  activeSlotIdx = slotIdx;
  activeModalTeam = team || activeTeam;
  const tFormation = activeModalTeam === 'away' ? opponentFormation : currentFormation;
  const pos = FORMATIONS[tFormation].positions[slotIdx];
  document.getElementById('modalTitle').textContent = `${pos.role} ã«é…ç½®`;
  openPickerModal();
}

function openPickerModal() {
  // Populate league select
  const ls = document.getElementById('pickerLeagueSelect');
  ls.innerHTML = '<option value="">-- ãƒªãƒ¼ã‚°ã‚’é¸ã¶ --</option>';
  Object.keys(LEAGUES).forEach(league => {
    const o = document.createElement('option');
    o.value = league; o.textContent = league;
    ls.appendChild(o);
  });

  // Restore last selected league/team
  if (lastPickerLeague) {
    ls.value = lastPickerLeague;
    // Repopulate team dropdown for this league
    const ts = document.getElementById('pickerTeamSelect');
    ts.innerHTML = '<option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>';
    const teams = LEAGUES[lastPickerLeague] || {};
    Object.keys(teams).forEach(team => {
      const o = document.createElement('option');
      o.value = team;
      const info = teams[team];
      o.dataset.id = info.id;
      o.dataset.league = info.league;
      if (info.animeId) o.dataset.animeId = info.animeId;
      o.textContent = team + (loadedTeamPlayers[team] ? ' âœ“' : '');
      ts.appendChild(o);
    });
    ts.style.display = '';

    if (lastPickerTeam && loadedTeamPlayers[lastPickerTeam]) {
      ts.value = lastPickerTeam;
      pickerTeamPlayers = loadedTeamPlayers[lastPickerTeam];
      document.getElementById('pickerLoadStatus').textContent = `âœ… ${pickerTeamPlayers.length}äºº`;
    } else {
      ts.value = '';
      pickerTeamPlayers = [];
      document.getElementById('pickerLoadStatus').textContent = '';
    }
  } else {
    document.getElementById('pickerTeamSelect').style.display = 'none';
    document.getElementById('pickerTeamSelect').innerHTML = '<option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>';
    document.getElementById('pickerLoadStatus').textContent = '';
    pickerTeamPlayers = [];
  }

  document.getElementById('modalSearch').value = '';
  refreshPickerList();
  document.getElementById('slotModal').classList.add('open');
}


function openBenchModal(benchIdx, team) {
  activeModalMode = 'bench';
  activeBenchIdx = benchIdx;
  activeModalTeam = team || activeTeam;
  document.getElementById('modalTitle').textContent = `ãƒ™ãƒ³ãƒ ${benchIdx + 1} ã®é¸æ‰‹`;
  openPickerModal();
}


function openSwapModal(benchIdx, team) {
  activeModalTeam = team || activeTeam;
  const isAway = activeModalTeam === 'away';
  const tBench = isAway ? opponentBench : bench;
  const tLineup = isAway ? opponentLineup : lineup;
  const tFormation = isAway ? opponentFormation : currentFormation;
  const benchPlayer = tBench[benchIdx];
  if (!benchPlayer) return;
  const positions = FORMATIONS[tFormation].positions;
  activeModalMode = 'swap';
  activeBenchIdx = benchIdx;
  document.getElementById('modalTitle').textContent = `${benchPlayer.name} ã‚’äº¤ä»£ã•ã›ã‚‹`;
  document.getElementById('modalSearch').value = '';
  allModalPlayers = positions.map((pos, si) => {
    const p = tLineup[si];
    return {
      name: p ? p.name : `(ç©ºã) ${pos.role}`,
      pos: pos.role,
      num: p ? p.num : null,
      img: p ? p.img : null,
      _isSwap: true, _si: si, _stPlayer: p || null
    };
  });
  renderModal(allModalPlayers);
  document.getElementById('slotModal').classList.add('open');
}
function openSlotPicker(player) {
  // From player list: find empty slots
  const isAway = activeTeam === 'away';
  const tLineup = isAway ? opponentLineup : lineup;
  const tFormation = isAway ? opponentFormation : currentFormation;
  activeModalTeam = activeTeam;
  const positions = FORMATIONS[tFormation].positions;
  const emptySlots = positions.map((p,i) => i).filter(i => !tLineup[i]);
  if (emptySlots.length === 0) { showToast('ç©ºãã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  if (emptySlots.length === 1) {
    tLineup[emptySlots[0]] = player;
    renderPitch(); renderLineupList(); renderPlayerList(); return;
  }
  // Show slot picker modal
  activeSlotIdx = null;
  document.getElementById('modalTitle').textContent = `${player.name} ã‚’é…ç½®ã™ã‚‹ãƒã‚¸ã‚·ãƒ§ãƒ³`;
  document.getElementById('modalSearch').value = '';
  const slotItems = emptySlots.map(si => ({
    name: `${positions[si].role} (ã‚¹ãƒ­ãƒƒãƒˆ${si+1})`,
    pos: positions[si].role,
    _isSlot: true,
    _slotIdx: si,
    _player: player
  }));
  allModalPlayers = slotItems;
  renderModal(slotItems);
  document.getElementById('slotModal').classList.add('open');
}

function filterModal() {
  refreshPickerList();
}


// ============================================================
// PICKER MODAL: team/league filter + cross-team search
// ============================================================

// State for which team is loaded in picker
let pickerTeamPlayers = []; // players of currently selected picker team
let lastPickerLeague = '';   // remembered across modal opens
let lastPickerTeam = '';     // remembered across modal opens

function onPickerLeagueChange() {
  const league = document.getElementById('pickerLeagueSelect').value;
  const ts = document.getElementById('pickerTeamSelect');
  lastPickerLeague = league;
  lastPickerTeam = '';
  if (!league) {
    ts.style.display = 'none';
    ts.innerHTML = '<option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>';
    pickerTeamPlayers = [];
    refreshPickerList();
    return;
  }
  ts.innerHTML = '<option value="">-- ãƒãƒ¼ãƒ ã‚’é¸ã¶ --</option>';
  const teams = LEAGUES[league] || {};
  Object.keys(teams).forEach(team => {
    const o = document.createElement('option');
    o.value = team;
    const info = teams[team];
    o.dataset.id = info.id;
    o.dataset.league = info.league;
    if (info.animeId) o.dataset.animeId = info.animeId;
    o.textContent = team + (loadedTeamPlayers[team] ? ' âœ“' : '');
    ts.appendChild(o);
  });
  ts.style.display = '';
  pickerTeamPlayers = [];
  refreshPickerList();
}

async function onPickerTeamChange() {
  const ts = document.getElementById('pickerTeamSelect');
  const selected = ts.options[ts.selectedIndex];
  const teamName = selected.value;
  lastPickerTeam = teamName;
  if (!teamName) { pickerTeamPlayers = []; refreshPickerList(); return; }

  const teamId = selected.dataset.id;
  const teamLeague = selected.dataset.league;
  const animeId = selected.dataset.animeId ? parseInt(selected.dataset.animeId) : null;
  const status = document.getElementById('pickerLoadStatus');

  // Use cache if available
  if (loadedTeamPlayers[teamName]) {
    pickerTeamPlayers = loadedTeamPlayers[teamName];
    refreshPickerList();
    return;
  }

  status.textContent = 'â³ å–å¾—ä¸­...';
  try {
    let players = [];
    if (teamLeague === 'preset') {
      players = loadPresetPlayers(teamName);
    } else if (teamLeague === 'jpn.1') {
      players = await fetchWikiSquad(teamName);
      if (players.length < 3 && TEAM_PRESETS[teamName]) players = loadPresetPlayers(teamName);
    } else {
      players = await fetchESPNSquad(teamName, teamId, teamLeague);
    }
    loadedTeamPlayers[teamName] = players;
    rebuildAllPlayers();
    pickerTeamPlayers = players;
    status.textContent = `âœ… ${players.length}äºº`;
    refreshPickerList();
    // Also enrich with wiki photos in background
    if (teamLeague !== 'anime') {
      enrichWithWikiPhotos(players).then(() => {
        syncPhotosToLineupAndBench(players);
        refreshPickerList();
      });
    }
  } catch(e) {
    status.textContent = 'âš ï¸ å–å¾—å¤±æ•—';
    pickerTeamPlayers = [];
    refreshPickerList();
  }
}

function refreshPickerList() {
  const searchVal = document.getElementById('modalSearch').value.toLowerCase().trim();
  const pickerTeam = document.getElementById('pickerTeamSelect').value;
  const pickerLeague = document.getElementById('pickerLeagueSelect').value;

  let pool = [];

  if (pickerTeam && pickerTeamPlayers.length) {
    // Team selected: show that team's players
    pool = pickerTeamPlayers;
  } else if (searchVal && allPlayers.length) {
    // Name search across all loaded players (when no team selected)
    pool = allPlayers;
  } else {
    // Nothing selected, nothing to show
    allModalPlayers = [];
    renderModal([]);
    return;
  }

  // Filter by search (name, position, number)
  if (searchVal) {
    pool = pool.filter(p => {
      if (!p.name) return false;
      if (p.name.toLowerCase().includes(searchVal)) return true;
      if (p.pos && p.pos.toLowerCase().includes(searchVal)) return true;
      if (p.num && String(p.num).includes(searchVal)) return true;
      return false;
    });
  }

  // Exclude already placed players (check active team's lineup/bench)
  const tL = activeModalTeam === 'away' ? opponentLineup : lineup;
  const tB = activeModalTeam === 'away' ? opponentBench : bench;
  const inLineup = new Set(Object.values(tL).filter(Boolean).map(p => p.name));
  const inBench = new Set(tB.filter(Boolean).map(p => p.name));
  pool = pool.filter(p => !inLineup.has(p.name) && !inBench.has(p.name));

  allModalPlayers = pool;
  renderModal(pool);
}

function renderModal(players) {
  const ml = document.getElementById('modalPlayerList');
  ml.innerHTML = '';
  players.forEach(p => {
    const div = document.createElement('div');
    div.className = 'player-item';
    if (p._isSlot) {
      div.innerHTML = `<div class="p-info"><div class="p-name">${p.name}</div></div>`;
      div.onclick = () => {
        lineup[p._slotIdx] = p._player;
        closeModal(); renderPitch(); renderLineupList(); renderPlayerList();
      };
    } else {
      // Find team name for badge
      let teamBadge = '';
      for (const [tname, tplayers] of Object.entries(loadedTeamPlayers)) {
        if (tplayers.some(tp => tp.name === p.name)) {
          teamBadge = `<span class="picker-team-badge">${tname}</span>`;
          break;
        }
      }
      div.innerHTML = `
        <div class="p-avatar">${renderAvatar(p)}</div>
        <div class="p-info">
          <div class="p-name">${p.name}${teamBadge}</div>
          <div class="p-meta">${p.pos||''}${p.num?' #'+p.num:''}</div>
        </div>
      `;
      div.onclick = () => {
        const isAway = activeModalTeam === 'away';
        const tLineup = isAway ? opponentLineup : lineup;
        const tBench = isAway ? opponentBench : bench;
        if (activeModalMode === 'swap' && p._isSwap) {
          const benchP = tBench[activeBenchIdx];
          tBench[activeBenchIdx] = p._stPlayer || null;
          tLineup[p._si] = benchP;
          closeModal(); renderPitch(); renderLineupList(); updateLineupCount();
        } else if (activeModalMode === 'bench') {
          tBench[activeBenchIdx] = p;
          closeModal(); renderLineupList(); updateLineupCount();
        } else {
          tLineup[activeSlotIdx] = p;
          closeModal(); renderPitch(); renderLineupList(); renderPlayerList(); updateLineupCount();
        }
      };
    }
    ml.appendChild(div);
  });
  if (!players.length) {
    const empty = document.createElement('div');
    empty.style.cssText = 'color:var(--text-dim);padding:16px;font-size:0.78rem;text-align:center;';
    const hasTeam = document.getElementById('pickerTeamSelect').value;
    const hasSearch = document.getElementById('modalSearch').value.trim();
    if (!hasTeam && !hasSearch) {
      empty.innerHTML = 'â¬†ï¸ ãƒªãƒ¼ã‚°â†’ãƒãƒ¼ãƒ ã‚’é¸ã¶ã‹ã€åå‰ãƒ»èƒŒç•ªå·ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³ã§æ¤œç´¢ã—ã¦ãã ã•ã„';
    } else {
      empty.textContent = 'å€™è£œãŒã„ã¾ã›ã‚“';
    }
    ml.appendChild(empty);
  }
}

function closeModal() {
  document.getElementById('slotModal').classList.remove('open');
  // Don't clear pickerTeamPlayers - remember for next open
}


// ============================================================
// CUSTOM PLAYER: SEARCH
// ============================================================
function switchCustomTab(tab) {
  document.querySelectorAll('.custom-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.custom-tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'manage') renderCustomManageList();
}

async function searchPlayerImage() {
  const name = document.getElementById('customName').value.trim();
  if (!name) return;

  const btn = document.getElementById('searchBtn');
  const note = document.getElementById('searchNote');
  const results = document.getElementById('searchResults');
  results.innerHTML = '';
  note.innerHTML = '<span class="spinner"></span> æ¤œç´¢ä¸­...';
  document.getElementById('customPreviewRow').style.display = 'none';
  btn.disabled = true;

  // Collect candidate images from multiple sources in parallel
  const candidateUrls = new Set(); // deduplicate
  const foundImages = [];

  function addImage(src, label) {
    if (!src || candidateUrls.has(src)) return;
    candidateUrls.add(src);
    foundImages.push({src, label});
  }

  // Run all searches in parallel
  await Promise.allSettled([

    // --- 1. Wikipedia JP (main image) ---
    (async () => {
      const data = await fetch(
        `https://ja.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(name)}&prop=pageimages|images&format=json&pithumbsize=400&pilimit=5&origin=*`
      ).then(r => r.json());
      const page = Object.values(data.query.pages)[0];
      if (page?.thumbnail?.source) addImage(page.thumbnail.source, 'Wikipedia JP');
      // Also get all page images (good for anime chars)
      if (page?.images) {
        const imgNames = page.images.map(i => i.title).filter(t =>
          /\.(jpg|jpeg|png|webp)$/i.test(t) && !/logo|icon|flag|stub|question/i.test(t)
        ).slice(0, 3);
        for (const title of imgNames) {
          const imgData = await fetch(
            `https://ja.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=imageinfo&iiprop=url&format=json&origin=*`
          ).then(r => r.json()).catch(() => null);
          if (imgData) {
            const p = Object.values(imgData.query.pages)[0];
            const url = p?.imageinfo?.[0]?.url;
            if (url && /\.(jpg|jpeg|png|webp)$/i.test(url)) addImage(url, 'Wikipedia JP');
          }
        }
      }
    })(),

    // --- 2. Wikipedia EN ---
    (async () => {
      const data = await fetch(
        `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(name)}&prop=pageimages|images&format=json&pithumbsize=400&pilimit=5&origin=*`
      ).then(r => r.json());
      const page = Object.values(data.query.pages)[0];
      if (page?.thumbnail?.source) addImage(page.thumbnail.source, 'Wikipedia EN');
    })(),

    // --- 3. Wikidata: P18 (image), P154 (logo), P18 for fictional chars ---
    (async () => {
      // Search both JP and EN to find entity
      const [jaSearch, enSearch] = await Promise.all([
        fetch(`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(name)}&language=ja&format=json&origin=*&limit=3`).then(r=>r.json()),
        fetch(`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(name)}&language=en&format=json&origin=*&limit=3`).then(r=>r.json())
      ]);
      const entities = [...(jaSearch.search||[]), ...(enSearch.search||[])];
      const seen = new Set();
      for (const ent of entities) {
        if (seen.has(ent.id)) continue;
        seen.add(ent.id);
        const entity = await fetch(`https://www.wikidata.org/wiki/Special:EntityData/${ent.id}.json`).then(r=>r.json()).catch(()=>null);
        if (!entity) continue;
        const claims = entity.entities?.[ent.id]?.claims || {};
        // P18 = image, P154 = logo image, P6802 = related image
        for (const prop of ['P18','P154','P6802']) {
          const vals = claims[prop] || [];
          for (const v of vals.slice(0,2)) {
            const fname = v.mainsnak?.datavalue?.value;
            if (fname) {
              const url = await wikimediaFileUrl(fname);
              if (url) addImage(url, `Wikidata(${prop})`);
            }
          }
        }
      }
    })(),

    // --- 4. Wikimedia Commons: search by name (great for anime/manga/game chars) ---
    (async () => {
      const data = await fetch(
        `https://commons.wikimedia.org/w/api.php?action=query&list=search&srnamespace=6&srsearch=${encodeURIComponent(name)}&format=json&origin=*&srlimit=8`
      ).then(r => r.json());
      const hits = (data.query?.search || []).filter(h =>
        /\.(jpg|jpeg|png|webp|svg)$/i.test(h.title) && !/stub|logo|flag|map|icon/i.test(h.title)
      ).slice(0, 5);
      for (const hit of hits) {
        const imgData = await fetch(
          `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(hit.title)}&prop=imageinfo&iiprop=url&iiurlwidth=300&format=json&origin=*`
        ).then(r => r.json()).catch(() => null);
        if (imgData) {
          const p = Object.values(imgData.query?.pages || {})[0];
          const url = p?.imageinfo?.[0]?.thumburl || p?.imageinfo?.[0]?.url;
          if (url) addImage(url, 'Wikimedia Commons');
        }
      }
    })(),

    // --- 5. DuckDuckGo Instant Answer API (Instant Answers / info box images) ---
    (async () => {
      // DDG IA returns an "Image" field for known entities
      const data = await fetch(
        `https://api.duckduckgo.com/?q=${encodeURIComponent(name)}&format=json&no_html=1&skip_disambig=1`
      ).then(r => r.json()).catch(() => null);
      if (data?.Image && data.Image.startsWith('http')) addImage(data.Image, 'DuckDuckGo');
      // RelatedTopics may also have images
      for (const topic of (data?.RelatedTopics || []).slice(0,5)) {
        if (topic.Icon?.URL && topic.Icon.URL.startsWith('http')) addImage(topic.Icon.URL, 'DDG Related');
      }
    })(),

    // --- 6. Open Anime/Game DB: Jikan (MyAnimeList API) for anime chars ---
    (async () => {
      const data = await fetch(
        `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(name)}&limit=5`
      ).then(r => r.json()).catch(() => null);
      for (const char of (data?.data || [])) {
        if (char.images?.jpg?.image_url) addImage(char.images.jpg.image_url, 'MyAnimeList');
        if (char.images?.jpg?.small_image_url) addImage(char.images.jpg.small_image_url, 'MyAnimeList');
      }
    })(),

    // --- 7. RAWG (game characters/persons) ---
    // Skip - requires API key

    // --- 8. Avatar via unavatar.io (Twitter/GitHub/Gravatar aggregator) ---
    (async () => {
      // Works best for public figures with Twitter accounts
      // Use as low-confidence last resort â€” add as single candidate
      const twitterGuess = name.toLowerCase().replace(/\s+/g,'').replace(/[^\w]/g,'');
      if (twitterGuess.length >= 3) {
        addImage(`https://unavatar.io/twitter/${twitterGuess}?fallback=false`, 'Twitter(æ¨æ¸¬)');
      }
    })(),

  ]);

  btn.disabled = false;

  // Display found images - show immediately, remove on error
  if (foundImages.length > 0) {
    note.textContent = `å€™è£œã‚’èª­ã¿è¾¼ã¿ä¸­... (æœ€å¤§${foundImages.length}ä»¶)`;
    let loadedCount = 0;
    let errorCount = 0;

    foundImages.forEach(({src, label}) => {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'position:relative;display:inline-block;';

      const img = document.createElement('img');
      img.className = 'img-cand';
      img.src = src;
      img.title = label;
      img.loading = 'lazy';

      img.onload = () => {
        loadedCount++;
        note.textContent = `${loadedCount}ä»¶ã®ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚é¸æŠã—ã¦ãã ã•ã„ã€‚`;
      };
      img.onerror = () => {
        errorCount++;
        wrapper.remove();
        if (loadedCount === 0 && (loadedCount + errorCount) >= foundImages.length) {
          note.textContent = 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒã‚¿ãƒ¼ã§è¿½åŠ ã§ãã¾ã™ã€‚';
          pendingSearch = {name, imgSrc: null};
          showSearchPreview(null, name);
        }
      };
      img.onclick = () => {
        document.querySelectorAll('.img-cand').forEach(i => i.classList.remove('picked'));
        img.classList.add('picked');
        pendingSearch = {name, imgSrc: src};
        showSearchPreview(src, name);
      };

      // Label badge
      const badge = document.createElement('div');
      badge.style.cssText = 'position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);font-size:9px;color:#aaa;text-align:center;padding:1px;';
      badge.textContent = label;

      wrapper.appendChild(img);
      wrapper.appendChild(badge);
      results.appendChild(wrapper);
    });
  } else {
    note.textContent = 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒã‚¿ãƒ¼ã§è¿½åŠ ã§ãã¾ã™ã€‚';
    pendingSearch = {name, imgSrc: null};
    showSearchPreview(null, name);
  }
}

// Helper: get direct URL for a Wikimedia file by filename
async function wikimediaFileUrl(filename) {
  try {
    const encoded = filename.replace(/ /g, '_');
    const data = await fetch(
      `https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(encoded)}&prop=imageinfo&iiprop=url&iiurlwidth=300&format=json&origin=*`
    ).then(r => r.json());
    const page = Object.values(data.query?.pages || {})[0];
    return page?.imageinfo?.[0]?.thumburl || page?.imageinfo?.[0]?.url || null;
  } catch(e) { return null; }
}

function showSearchPreview(imgSrc, name) {
  const row = document.getElementById('customPreviewRow');
  const avatar = document.getElementById('customPreviewAvatar');
  row.style.display = 'block';
  document.getElementById('customNameConfirm').value = name;
  if (imgSrc) {
    avatar.innerHTML = `<img src="${imgSrc}" onerror="this.parentNode.innerHTML='ğŸ‘¤'">`;
  } else {
    avatar.innerHTML = getInitials(name);
  }
}

function addCustomPlayer() {
  const name = document.getElementById('customNameConfirm').value.trim() || (pendingSearch?.name||'');
  if (!name) { showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const pos = document.getElementById('customPos').value.trim() || 'MF';
  const num = parseInt(document.getElementById('customNum').value) || 0;
  const imgSrc = pendingSearch?.imgSrc || null;

  const player = {name, pos, num, img: imgSrc, custom: true, id: Date.now()};
  customPlayers.push(player);
  saveCustomPlayers();
  rebuildAllPlayers();
  renderPlayerList();
  showToast(`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
  resetSearchUI();
}

function resetSearchUI() {
  document.getElementById('customName').value = '';
  document.getElementById('customNameConfirm').value = '';
  document.getElementById('customPos').value = '';
  document.getElementById('customNum').value = '';
  document.getElementById('searchResults').innerHTML = '';
  document.getElementById('searchNote').textContent = '';
  document.getElementById('customPreviewRow').style.display = 'none';
  pendingSearch = null;
}

// ============================================================
// CUSTOM PLAYER: UPLOAD
// ============================================================
function handleUpload() {
  const file = document.getElementById('uploadFile').files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    uploadImgDataUrl = e.target.result;
    const preview = document.getElementById('uploadPreview');
    preview.innerHTML = `<img src="${uploadImgDataUrl}" style="width:100%;height:100%;object-fit:cover;">`;
  };
  reader.readAsDataURL(file);
}

function addUploadPlayer() {
  const name = document.getElementById('uploadName').value.trim();
  if (!name) { showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const pos = document.getElementById('uploadPos').value.trim() || 'MF';
  const num = parseInt(document.getElementById('uploadNum').value) || 0;

  const player = {name, pos, num, img: uploadImgDataUrl, custom: true, id: Date.now()};
  customPlayers.push(player);
  saveCustomPlayers();
  rebuildAllPlayers();
  renderPlayerList();
  showToast(`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);

  document.getElementById('uploadName').value = '';
  document.getElementById('uploadPos').value = '';
  document.getElementById('uploadNum').value = '';
  document.getElementById('uploadPreview').innerHTML = 'ğŸ‘¤';
  uploadImgDataUrl = null;
}

// ============================================================
// CUSTOM PLAYER: MANAGE & DELETE
// ============================================================
function renderCustomManageList() {
  const list = document.getElementById('customPlayerManageList');
  if (!customPlayers.length) {
    list.innerHTML = '<div style="color:var(--text-dim);font-size:0.75rem;padding:6px;">ã‚«ã‚¹ã‚¿ãƒ é¸æ‰‹ãªã—</div>';
    return;
  }
  list.innerHTML = '';
  customPlayers.forEach(p => {
    const div = document.createElement('div');
    div.className = 'player-item';
    div.style.padding = '5px 8px';
    div.innerHTML = `
      <div class="p-avatar">${p.img ? `<img src="${p.img}" onerror="this.parentNode.innerHTML='ğŸ‘¤'">` : getInitials(p.name)}</div>
      <div class="p-info">
        <div class="p-name">${p.name}</div>
        <div class="p-meta">${p.pos||''} ${p.num?'#'+p.num:''}</div>
      </div>
      <button class="btn-xs danger" style="padding:4px 8px;font-size:0.7rem;" onclick="deleteCustomPlayer('${p.name}')">å‰Šé™¤</button>
    `;
    list.appendChild(div);
  });
}

function deleteCustomPlayer(name, e) {
  if (e) e.stopPropagation();
  customPlayers = customPlayers.filter(p => p.name !== name);
  saveCustomPlayers();
  rebuildAllPlayers();
  // Remove from lineup if placed
  Object.keys(lineup).forEach(i => { if (lineup[i].name === name) delete lineup[i]; });
  renderPitch(); renderLineupList(); renderPlayerList(); renderCustomManageList();
  showToast(`${name} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
}

function saveCustomPlayers() {
  try {
    // Don't save large base64 images to localStorage (size limit)
    const toSave = customPlayers.map(p => ({
      ...p,
      img: p.img && p.img.startsWith('data:') ? null : p.img
    }));
    localStorage.setItem('customPlayers', JSON.stringify(toSave));
  } catch(e) {}
}

// ============================================================
// LINEUP ACTIONS
// ============================================================
function clearLineup() {
  if (!confirm('ã‚¹ã‚¿ãƒ¡ãƒ³ã¨ãƒ™ãƒ³ãƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  if (activeTeam === 'away') {
    opponentLineup = {};
    opponentBench = [null, null, null, null, null];
  } else {
    lineup = {};
    bench = [null, null, null, null, null];
  }
  renderPitch();
  renderLineupList();
  renderPlayerList();
  updateLineupCount();
}


function showQR() {
  const url = window.location.href;
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
  document.getElementById('qrCodeArea').innerHTML = `<img src="${qrUrl}" width="200" height="200" style="border-radius:6px;">`;
  document.getElementById('qrUrlText').textContent = url;
  document.getElementById('qrModal').classList.add('open');
}
async function exportPNG() {
  // å¯¾æˆ¦ç›¸æ‰‹ONãªã‚‰ pitchArea å…¨ä½“ã‚’ã€OFFãªã‚‰homeãƒ”ãƒƒãƒã®ã¿ã‚­ãƒ£ãƒ—ãƒãƒ£
  const captureEl = opponentEnabled
    ? document.getElementById('pitchArea')
    : document.getElementById('pitchWrap');
  if (!captureEl) { showToast('ãƒ”ãƒƒãƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  showToast('ğŸ“¸ ç”»åƒç”Ÿæˆä¸­...');

  try {
    const canvas = await html2canvas(captureEl, {
      backgroundColor: opponentEnabled ? '#101410' : '#1a3a14',
      scale: 2,
      useCORS: false,
      allowTaint: false,
      logging: false,
      imageTimeout: 0,
    });

    if (navigator.clipboard && window.ClipboardItem) {
      canvas.toBlob(async (blob) => {
        try {
          await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
          showToast('âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        } catch(e) {
          downloadCanvas(canvas);
        }
      }, 'image/png');
    } else {
      downloadCanvas(canvas);
    }
  } catch(e) {
    console.warn('html2canvas failed:', e);
    showToast('âš ï¸ ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

function downloadCanvas(canvas) {
  const link = document.createElement('a');
  link.download = 'lineup_' + new Date().toISOString().slice(0,10) + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
  showToast('âœ… ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ============================================================
// EVENT LISTENERS
// ============================================================
document.getElementById('slotModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('customName').addEventListener('keydown', e => {
  if (e.key === 'Enter') searchPlayerImage();
});

// ============================================================
// START
// ============================================================
init();

// ============================================================
// LINEUP SAVE / LOAD  (localStorage, max 10 slots)
// ============================================================
const LS_KEY = 'lineup_saves';

function getSaves() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e) { return []; }
}
function putSaves(arr) {
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}

function openSaveModal() {
  const saves = getSaves();
  const list = document.getElementById('saveSlotList');
  list.innerHTML = '';
  // Show existing saves
  if (saves.length) {
    const label = document.createElement('div');
    label.style.cssText = 'font-size:0.65rem;color:var(--text-dim);margin-bottom:6px;letter-spacing:1px;';
    label.textContent = 'æ—¢å­˜ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸Šæ›¸ãå¯ï¼‰';
    list.appendChild(label);
    saves.forEach((s, i) => {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--panel-border);border-radius:4px;margin-bottom:4px;cursor:pointer;font-size:0.78rem;';
      row.innerHTML = `<span style="flex:1;">${s.name}</span><span style="font-size:0.65rem;color:var(--text-dim);">${s.formation} Â· ${new Date(s.ts).toLocaleDateString('ja')}</span>`;
      row.onclick = () => { document.getElementById('saveNameInput').value = s.name; };
      list.appendChild(row);
    });
  }
  document.getElementById('saveNameInput').value = '';
  document.getElementById('saveModal').classList.add('open');
  setTimeout(() => document.getElementById('saveNameInput').focus(), 100);
}

function doSaveLineup() {
  const name = document.getElementById('saveNameInput').value.trim() || 'åç§°æœªè¨­å®š';
  const saves = getSaves();
  const existing = saves.findIndex(s => s.name === name);
  const data = {
    name, ts: Date.now(),
    formation: currentFormation,
    lineup: lineup,
    bench: bench,
    teamColor: currentTeamColor
  };
  if (existing >= 0) saves[existing] = data;
  else saves.push(data);
  if (saves.length > 10) saves.shift(); // cap at 10
  putSaves(saves);
  document.getElementById('saveModal').classList.remove('open');
  showToast(`âœ… ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
}

function openLoadModal() {
  const saves = getSaves();
  const list = document.getElementById('loadSlotList');
  list.innerHTML = '';
  if (!saves.length) {
    list.innerHTML = '<div style="color:var(--text-dim);padding:16px;text-align:center;font-size:0.78rem;">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    saves.slice().reverse().forEach((s, i) => {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--panel-border);border-radius:5px;margin-bottom:5px;cursor:pointer;transition:border-color .15s;';
      row.onmouseover = () => row.style.borderColor = 'rgba(200,245,96,.4)';
      row.onmouseout = () => row.style.borderColor = 'var(--panel-border)';
      const starters = Object.keys(s.lineup || {}).length;
      row.innerHTML = `
        <div style="flex:1;">
          <div style="font-size:0.82rem;font-weight:700;">${s.name}</div>
          <div style="font-size:0.65rem;color:var(--text-dim);">${s.formation} Â· ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼${starters}äºº Â· ${new Date(s.ts).toLocaleDateString('ja')}</div>
        </div>
        <button class="btn-xs" onclick="doLoadLineup(${saves.length-1-i});event.stopPropagation();" style="padding:4px 8px;font-size:0.68rem;">èª­ã¿è¾¼ã‚€</button>
        <button class="btn-xs danger" onclick="doDeleteSave(${saves.length-1-i});event.stopPropagation();" style="padding:4px 8px;font-size:0.68rem;">å‰Šé™¤</button>
      `;
      row.onclick = () => doLoadLineup(saves.length-1-i);
      list.appendChild(row);
    });
  }
  document.getElementById('loadModal').classList.add('open');
}

function doLoadLineup(idx) {
  const saves = getSaves();
  const s = saves[idx];
  if (!s) return;
  currentFormation = s.formation;
  lineup = s.lineup || {};
  bench = s.bench || [null,null,null,null,null];
  if (s.teamColor) { currentTeamColor = s.teamColor; applyTeamColor(); }
  document.querySelectorAll('.formation-btn').forEach(b => b.classList.toggle('active', b.textContent===currentFormation));
  document.getElementById('loadModal').classList.remove('open');
  renderPitch(); renderLineupList(); renderPlayerList(); updateLineupCount();
  showToast(`âœ… ã€Œ${s.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
}

function doDeleteSave(idx) {
  const saves = getSaves();
  const name = saves[idx]?.name;
  saves.splice(idx, 1);
  putSaves(saves);
  openLoadModal(); // refresh
  showToast(`ğŸ—‘ ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
}

// ============================================================
// TEAM COLOR  (accent color for pitch player circles)
// ============================================================
let currentTeamColor = '#c8f560'; // default accent

function applyTeamColor() {
  document.documentElement.style.setProperty('--accent', currentTeamColor);
}

// ============================================================
// PLAYER NAME INLINE EDIT
// Double-tap/click on player name label on pitch
// ============================================================
function editPlayerName(slotIdx, team, e) {
  e.stopPropagation();
  const tLineup = team === 'away' ? opponentLineup : lineup;
  const player = tLineup[slotIdx];
  if (!player) return;
  const label = document.querySelector(`.pitch-player[data-slot="${slotIdx}"][data-team="${team}"] .pp-label`);
  if (!label) return;
  const current = player.name;
  const input = document.createElement('input');
  input.value = current;
  input.style.cssText = 'width:72px;font-size:0.62rem;padding:2px 4px;background:#111;color:#fff;border:1px solid var(--accent);border-radius:3px;text-align:center;outline:none;';
  label.innerHTML = '';
  label.appendChild(input);
  input.focus(); input.select();
  const commit = () => {
    const newName = input.value.trim() || current;
    player.name = newName;
    renderPitch(); renderLineupList();
  };
  input.onblur = commit;
  input.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); commit(); } if (e.key === 'Escape') { player.name = current; renderPitch(); renderLineupList(); } };
}

// ============================================================
// DRAG STATE + TOUCH DRAG
// ============================================================
const dragState = { active: false, slot: null };

let touchDragSrc = null;
let touchGhost = null;
let touchStartPos = {x:0, y:0};

function onTouchStart(e, slot, type, team, player) {
  const touch = e.touches[0];
  touchStartPos = {x: touch.clientX, y: touch.clientY};
  touchDragSrc = {type, slot, team: team || 'home', el: e.currentTarget, timer: null, player: player || null};

  touchDragSrc.timer = setTimeout(() => {
    if (!touchDragSrc) return;
    dragState.active = true;
    const srcEl = touchDragSrc.el;
    touchGhost = srcEl.cloneNode(true);
    touchGhost.style.cssText = 'position:fixed;pointer-events:none;z-index:9999;opacity:0.85;transform:translate(-50%,-50%) scale(1.1);transition:none;left:'+touch.clientX+'px;top:'+touch.clientY+'px;width:'+srcEl.offsetWidth+'px;';
    document.body.appendChild(touchGhost);
    srcEl.style.opacity = '0.35';
    if (navigator.vibrate) navigator.vibrate(30);
  }, 280);
}

document.addEventListener('touchmove', e => {
  if (!touchDragSrc) return;
  const touch = e.touches[0];
  const dx = touch.clientX - touchStartPos.x, dy = touch.clientY - touchStartPos.y;
  if (!dragState.active && (Math.abs(dx)>8||Math.abs(dy)>8)) {
    clearTimeout(touchDragSrc.timer); touchDragSrc = null; return;
  }
  if (!dragState.active) return;
  e.preventDefault();
  if (touchGhost) { touchGhost.style.left=touch.clientX+'px'; touchGhost.style.top=touch.clientY+'px'; }
  document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
  const underEl = document.elementFromPoint(touch.clientX, touch.clientY);
  const target = underEl?.closest('.pitch-player[data-slot]') || underEl?.closest('.lineup-slot[data-slot]');
  if (target) target.classList.add('drag-over');
}, {passive:false});

document.addEventListener('touchend', e => {
  if (!touchDragSrc) return;
  clearTimeout(touchDragSrc.timer);
  if (dragState.active) {
    const touch = e.changedTouches[0];
    if (touchGhost) { touchGhost.remove(); touchGhost = null; }
    if (touchDragSrc.el) touchDragSrc.el.style.opacity = '';
    document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
    const underEl = document.elementFromPoint(touch.clientX, touch.clientY);
    const pitchT = underEl?.closest('.pitch-player[data-slot]');
    const listT  = underEl?.closest('.lineup-slot[data-slot]');
    const tSlot  = pitchT ? parseInt(pitchT.dataset.slot) : (listT ? parseInt(listT.dataset.slot) : null);
    const tTeam  = pitchT?.dataset?.team || touchDragSrc.team;

    if (touchDragSrc.type === 'playerList' && touchDragSrc.player) {
      // é¸æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ”ãƒƒãƒã¸
      if (pitchT && tTeam) {
        const pSlot = parseInt(pitchT.dataset.slot);
        const tL = tTeam === 'away' ? opponentLineup : lineup;
        const inLineup = Object.values(tL).filter(Boolean).map(p=>p.name);
        if (!inLineup.includes(touchDragSrc.player.name)) {
          tL[pSlot] = touchDragSrc.player;
          renderPitch(); renderLineupList(); renderPlayerList(); updateLineupCount();
        }
      } else if (listT && listT.dataset.bench) {
        // é¸æ‰‹ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ™ãƒ³ãƒã¸
        const bi = parseInt(listT.dataset.benchIdx);
        const team2 = touchDragSrc.team;
        const tB = team2 === 'away' ? opponentBench : bench;
        const tL2 = team2 === 'away' ? opponentLineup : lineup;
        const inBench = tB.filter(Boolean).map(p=>p.name);
        const inLineup2 = Object.values(tL2).filter(Boolean).map(p=>p.name);
        if (!isNaN(bi) && !inBench.includes(touchDragSrc.player.name) && !inLineup2.includes(touchDragSrc.player.name)) {
          tB[bi] = touchDragSrc.player;
          renderLineupList(); renderPlayerList(); updateLineupCount();
        }
      }
    } else if (touchDragSrc.type === 'bench' && pitchT) {
      // ãƒ™ãƒ³ãƒã‹ã‚‰ãƒ”ãƒƒãƒã¸
      const pSlot = parseInt(pitchT.dataset.slot);
      const team2 = tTeam || touchDragSrc.team;
      const tL = team2 === 'away' ? opponentLineup : lineup;
      const tB = team2 === 'away' ? opponentBench : bench;
      const benchPlayer = tB[touchDragSrc.slot];
      if (benchPlayer) {
        const old = tL[pSlot] || null;
        tL[pSlot] = benchPlayer;
        tB[touchDragSrc.slot] = old;
        renderPitch(); renderLineupList(); updateLineupCount();
      }
    } else if (tSlot !== null && tSlot !== touchDragSrc.slot && tTeam === touchDragSrc.team) {
      const tL = touchDragSrc.team === 'away' ? opponentLineup : lineup;
      const tmp=tL[touchDragSrc.slot]; tL[touchDragSrc.slot]=tL[tSlot]; tL[tSlot]=tmp;
      renderPitch(); renderLineupList(); updateLineupCount();
    }
    dragState.active = false;
  }
  touchDragSrc = null;
});

document.addEventListener('touchcancel', () => {
  if (touchDragSrc) { clearTimeout(touchDragSrc.timer); if(touchDragSrc.el) touchDragSrc.el.style.opacity=''; }
  if (touchGhost) { touchGhost.remove(); touchGhost = null; }
  document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
  dragState.active = false; touchDragSrc = null;
});

// ============================================================
// SHARE URL
// ============================================================
function getShareURL() {
  const state = {
    f: currentFormation,
    l: Object.fromEntries(Object.entries(lineup).map(([k,v])=>[k,{n:v.name,p:v.pos,num:v.num}])),
    b: bench.map(p=>p?{n:p.name,p:p.pos,num:p.num}:null),
    c: currentTeamColor
  };
  try { return location.href.split('#')[0]+'#'+btoa(encodeURIComponent(JSON.stringify(state))); } catch(e) { return location.href; }
}

function loadFromHash() {
  if (!location.hash) return;
  try {
    const state = JSON.parse(decodeURIComponent(atob(location.hash.slice(1))));
    if (state.f && FORMATIONS[state.f]) {
      currentFormation = state.f;
      document.querySelectorAll('.formation-btn').forEach(b=>b.classList.toggle('active',b.textContent===currentFormation));
    }
    lineup = {};
    Object.entries(state.l||{}).forEach(([k,v])=>{ lineup[k]={name:v.n,pos:v.p,num:v.num,img:null}; });
    bench = (state.b||[null,null,null,null,null]).map(p=>p?{name:p.n,pos:p.p,num:p.num,img:null}:null);
    if (state.c) { currentTeamColor=state.c; applyTeamColor(); const cp=document.getElementById('teamColorPicker'); if(cp) cp.value=state.c; }
    renderPitch(); renderLineupList(); updateLineupCount();
    showToast('âœ… ã‚·ã‚§ã‚¢ã•ã‚ŒãŸãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } catch(e) {}
}

function showShareModal() {
  const url = getShareURL();
  document.getElementById('shareUrlText').value = url;
  document.getElementById('shareQRImg').src = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data='+encodeURIComponent(url);
  document.getElementById('shareModal').classList.add('open');
}

function copyShareURL() {
  const url = document.getElementById('shareUrlText').value;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(url).then(()=>showToast('âœ… URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')).catch(()=>fallbackCopy(url));
  } else { fallbackCopy(url); }
}
function fallbackCopy(url) {
  const ta = document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('âœ… URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
}

// ============================================================
// OPPONENT TOGGLE & TEAM SWITCHING
// ============================================================
function toggleOpponent() {
  opponentEnabled = !opponentEnabled;
  const awayContainer = document.getElementById('awayContainer');
  awayContainer.style.display = opponentEnabled ? 'flex' : 'none';
  document.getElementById('pitchArea').classList.toggle('opponent-mode', opponentEnabled);
  document.getElementById('teamTabs').classList.toggle('visible', opponentEnabled);
  const btn = document.getElementById('opponentBtn');
  btn.classList.toggle('btn-active', opponentEnabled);
  if (opponentEnabled) {
    renderTeamPitch('away');
    showToast('âš”ï¸ å¯¾æˆ¦ç›¸æ‰‹ON â€” AWAYã‚¿ãƒ–ã§è¨­å®šã§ãã¾ã™');
  } else {
    if (activeTeam === 'away') setActiveTeam('home');
    showToast('å¯¾æˆ¦ç›¸æ‰‹OFF');
  }
}

function setActiveTeam(team) {
  activeTeam = team;
  document.getElementById('homeTab').classList.toggle('active', team === 'home');
  document.getElementById('awayTab').classList.toggle('active', team === 'away');
  document.getElementById('homeContainer').classList.toggle('active-team', team === 'home');
  document.getElementById('awayContainer').classList.toggle('active-team', team === 'away');
  // Update formation buttons to show active team's formation
  const tFormation = team === 'away' ? opponentFormation : currentFormation;
  document.querySelectorAll('.formation-btn').forEach(b => b.classList.toggle('active', b.textContent === tFormation));
  renderLineupList();
  updateLineupCount();
}

function setActiveTeamClick(team) {
  if (!opponentEnabled) return;
  setActiveTeam(team);
}

// ============================================================
// PINCH ZOOM (mobile)
// ============================================================
let pitchZoom = 1;
let _pinchDist0 = 0;
let _pinching = false;

function initPitchZoom() {
  const area = document.getElementById('pitchArea');
  area.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      _pinching = true;
      _pinchDist0 = _getPinchDist(e.touches);
      e.preventDefault();
    }
  }, { passive: false });
  area.addEventListener('touchmove', e => {
    if (!_pinching || e.touches.length !== 2) return;
    e.preventDefault();
    const dist = _getPinchDist(e.touches);
    if (_pinchDist0 === 0) { _pinchDist0 = dist; return; }
    pitchZoom = Math.min(3, Math.max(1, pitchZoom * (dist / _pinchDist0)));
    _pinchDist0 = dist;
    _applyPitchZoom();
  }, { passive: false });
  area.addEventListener('touchend', e => {
    if (e.touches.length < 2) { _pinching = false; _pinchDist0 = 0; }
  });
  // Double-tap to reset zoom
  let _lastTap = 0;
  area.addEventListener('touchend', e => {
    if (_pinching) return;
    const now = Date.now();
    if (now - _lastTap < 300 && e.touches.length === 0) {
      pitchZoom = 1;
      _applyPitchZoom();
    }
    _lastTap = now;
  });
}
function _getPinchDist(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}
function _applyPitchZoom() {
  ['pitchWrap', 'opponentPitchWrap'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.transform = `scale(${pitchZoom})`; el.style.transformOrigin = 'center center'; }
  });
}

// ============================================================
// FLIP PITCH
// ============================================================
let pitchFlipped = false;
function flipPitch() {
  pitchFlipped = !pitchFlipped;
  const wrap = document.getElementById('pitchWrap');
  wrap.style.transform = pitchFlipped ? 'scaleY(-1)' : '';
  document.querySelectorAll('.pp-label,.pp-badge').forEach(el=>{el.style.transform=pitchFlipped?'scaleY(-1)':'';});
  showToast(pitchFlipped ? 'â¬†ï¸ æ”»æ’ƒæ–¹å‘: ä¸Š' : 'â¬‡ï¸ æ”»æ’ƒæ–¹å‘: ä¸‹');
}

</script>
</body>
</html>
